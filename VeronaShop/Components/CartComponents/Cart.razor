@page "/cart"
@inject VeronaShop.Services.CartService CartService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using VeronaShop.Data
@using MudBlazor
@rendermode InteractiveServer

<h3>@L["YourCart"]</h3>
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L

@if (cart == null)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (!cart.Items.Any())
{
    <MudPaper Class="pa-4">@L["CartEmpty"] <a href="/shop">@L["ShopTitle"]</a> @L["ToAddProducts"]</MudPaper>
}
else
{
    <MudTable Items="cart.Items" Dense="true" Hover="true">
        <HeaderContent>
            <MudTh></MudTh>
            <MudTh>@L["Product"]</MudTh>
            <MudTh>@L["Price"]</MudTh>
            <MudTh>@L["Quantity"]</MudTh>
            <MudTh>@L["Line"]</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd><img src="@(string.IsNullOrEmpty(context.Product.ImageUrl) ? "images/placeholder.svg" : context.Product.ImageUrl)" style="width:60px;height:60px;object-fit:cover" /></MudTd>
            <MudTd>
                <a href="/product/@context.ProductId">@context.Product.Name</a>
                @if (GetSizes(context.Product).Any())
                {
                    <div class="mt-1" style="min-width:140px;">
                        <MudSelect T="string"
                                   Value="context.SizeName"
                                   ValueChanged="@(async val => await UpdateSize(context.Id, val))"
                                   Dense="true"
                                   CloseMenuOnItemClick="true"
                                   Placeholder="@L["Size"]">
                            @foreach (var s in GetSizes(context.Product))
                            {
                                <MudSelectItem T="string" Value="@s">@s</MudSelectItem>
                            }
                        </MudSelect>
                    </div>
                }
                else if (!string.IsNullOrEmpty(context.SizeName))
                {
                    <div class="mud-caption">Size: @context.SizeName</div>
                }
            </MudTd>
            <MudTd>@($"LYD {context.UnitPrice:N2}")</MudTd>
            <MudTd>
                <MudNumericField T="int" Value="context.Quantity" Min="1" Immediate="false" ValueChanged="@(async (val) => await UpdateQuantity(context.Id, val))" />
            </MudTd>
            <MudTd>@($"LYD {(context.UnitPrice * context.Quantity):N2}")</MudTd>
            <MudTd>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="@(async ()=> await Remove(context.Id))">@L["Remove"]</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>

    <div class="d-flex justify-end mt-4">
        <MudPaper Class="pa-4" Style="min-width:320px;">
            <div class="d-flex justify-space-between">
                <div>@L["Subtotal"]</div>
                <div>@($"LYD {cart.Items.Sum(i => i.UnitPrice * i.Quantity):N2}")</div>
            </div>
            <div class="d-flex justify-space-between mt-2">
                <div>@L["Shipping"]</div>
                <div>@("LYD 0.00")</div>
            </div>
            <hr />
            <div class="d-flex justify-space-between font-weight-bold">
                <div>@L["Total"]</div>
                <div>@($"LYD {cart.Items.Sum(i => i.UnitPrice * i.Quantity):N2}")</div>
            </div>

            @if (isAuthenticated)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="GoToCheckout">@L["ProceedToCheckout"]</MudButton>
            }
            else
            {
                <div class="mt-4">
                    <p>@L["Please"] <a href="/account/login?returnUrl=/checkout">@L["LogIn"]</a> @L["ToProceedToCheckout"]</p>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RedirectToLogin">@L["LogIn"]</MudButton>
                </div>
            }
        </MudPaper>
    </div>
}

@code{
    private VeronaShop.Data.Entites.Cart cart;
    [Inject] private VeronaShop.Services.CartSessionService CartSession { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var sessionId = await CartSession.GetOrCreateSessionIdAsync();
        cart = await CartService.GetOrCreateCartAsync(sessionId);

        var authState = await authenticationStateTask;
        isAuthenticated = authState?.User?.Identity?.IsAuthenticated == true;
    }

    private async Task Remove(int id)
    {
        try
        {
            await CartService.RemoveItemAsync(id);
            var sessionId = await CartSession.GetOrCreateSessionIdAsync();
            cart = await CartService.GetOrCreateCartAsync(sessionId);
            Snackbar.Add(L["ItemRemoved"], Severity.Success);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            Snackbar.Add(L["ItemRemoveFailed"], Severity.Error);
        }
    }

    private async Task UpdateQuantity(int cartItemId, int quantity)
    {
        try
        {
            await CartService.UpdateItemQuantityAsync(cartItemId, quantity);
            var sessionId = await CartSession.GetOrCreateSessionIdAsync();
            cart = await CartService.GetOrCreateCartAsync(sessionId);
            Snackbar.Add(L["CartUpdated"], Severity.Success);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            Snackbar.Add(L["CartUpdateFailed"], Severity.Error);
        }
    }

    private async Task UpdateSize(int cartItemId, string size)
    {
        try
        {
            await CartService.UpdateItemSizeAsync(cartItemId, size);
            var sessionId = await CartSession.GetOrCreateSessionIdAsync();
            cart = await CartService.GetOrCreateCartAsync(sessionId);
            Snackbar.Add(L["CartUpdated"], Severity.Success);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            Snackbar.Add(L["CartUpdateFailed"], Severity.Error);
        }
    }

    private IEnumerable<string> GetSizes(VeronaShop.Data.Entites.Product product)
    {
        if (product == null || string.IsNullOrWhiteSpace(product.SizesCsv)) return Enumerable.Empty<string>();
        return product.SizesCsv.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(s => s.Trim());
    }

    private void RedirectToLogin()
    {
        var returnUrl = "/checkout";
        Navigation.NavigateTo($"/account/login?returnUrl={Uri.EscapeDataString(returnUrl)}");
    }

    private void GoToCheckout()
    {
        Navigation.NavigateTo("/checkout");
    }

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    private bool isAuthenticated;
}
