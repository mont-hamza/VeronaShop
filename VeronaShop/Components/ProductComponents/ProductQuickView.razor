@using VeronaShop.Data.Entites
@using System.Linq
@using MudBlazor
@using MudBlazor.Services
@inject ISnackbar Snackbar
@inject VeronaShop.Services.CartService CartService
@inject VeronaShop.Services.CartSessionService CartSession
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L

<style>
  /* animate dialog content when opened */
  .mud-dialog .mud-dialog-content > .quick-view-root {
    animation: quickViewIn 220ms ease-out;
  }
  @@keyframes quickViewIn {
    0% { transform: scale(0.96) translateY(8px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
  }
</style>

<div class="quick-view-root" style="position:relative;">
    <MudIconButton Icon="Icons.Material.Filled.Close" Color="Color.Inherit" Size="Size.Small" Style="position:absolute;right:8px;top:8px;z-index:10;" OnClick="@( () => Close() )" />
    <div class="d-flex" style="gap:16px;flex-wrap:wrap;">
        <div style="flex:1 1 600px;min-width:320px;display:flex;align-items:center;justify-content:center;">
            <img id="quickViewImage" src="@(GetCurrentImage())" alt="@Product?.Name" style="max-width:100%;max-height:720px;object-fit:contain;border-radius:6px;" />
            <div style="position:absolute;left:8px;top:50%;transform:translateY(-50%);">
                <MudIconButton Icon="Icons.Material.Filled.ChevronLeft" Color="Color.Inherit" OnClick="@( () => PrevImage() )" />
            </div>
            <div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);">
                <MudIconButton Icon="Icons.Material.Filled.ChevronRight" Color="Color.Inherit" OnClick="@( () => NextImage() )" />
            </div>
        </div>
        <div style="flex:1 1 320px;min-width:260px;">
            <MudText Typo="Typo.h6" Color="Color.Primary">@string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", Product?.Price)</MudText>
            <MudText Typo="Typo.body1" Class="mt-2">@Product?.Description</MudText>
            <div class="mt-4 d-flex" style="gap:8px;align-items:center;">
            @if (AvailableSizes.Any())
                {
                    <MudSelect T="string" @bind-Value="selectedSize" Label="@L["Size"]" Dense="true" Style="min-width:120px;">
                        @foreach (var s in AvailableSizes)
                        {
                            <MudSelectItem T="string" Value="@s">@s</MudSelectItem>
                        }
                    </MudSelect>
                }
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(async () => await AddToCart())">@L["AddToCart"]</MudButton>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public Product Product { get; set; }
    [CascadingParameter] MudBlazor.IDialogReference DialogReference { get; set; }
    [CascadingParameter] MudBlazor.DialogOptions DialogOptions { get; set; }

    private async Task AddToCart()
    {
        if (Product == null) return;
        try
        {
            var sessionId = await CartSession.GetOrCreateSessionIdAsync();
            var cart = await CartService.GetOrCreateCartAsync(sessionId);
            int? sizeId = null;
            string? sizeName = null;
            if (!string.IsNullOrEmpty(selectedSize))
            {
                sizeName = selectedSize;
            }
            else if (AvailableSizes.Any())
            {
                Snackbar.Add(L["PleaseSelectSize"], Severity.Warning);
                return;
            }
            await CartService.AddToCartAsync(cart, Product.Id, 1, sizeId, sizeName);
            Snackbar.Add(L["AddedToCart"], Severity.Success);
            DialogReference.Close();
        }
        catch
        {
            Snackbar.Add(L["FailedAddToCart"], Severity.Error);
        }
    }

    private List<string> AvailableSizes =>
        string.IsNullOrWhiteSpace(Product?.SizesCsv) ? new List<string>() : Product.SizesCsv.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(s => s.Trim()).ToList();

    private string selectedSize;

    private void Close()
    {
        try
        {
            DialogReference?.Close();
        }
        catch { }
    }

    private int currentIndex = 0;
    private string GetCurrentImage()
    {
        if (Product == null) return "images/placeholder.svg";
        if (Product.Images != null && Product.Images.Any())
        {
            currentIndex = Math.Clamp(currentIndex, 0, Product.Images.Count - 1);
            return Product.Images.OrderBy(i => i.SortOrder).ElementAt(currentIndex).Url;
        }
        return string.IsNullOrEmpty(Product.ImageUrl) ? "images/placeholder.svg" : Product.ImageUrl;
    }

    private void NextImage()
    {
        if (Product?.Images == null || !Product.Images.Any()) return;
        currentIndex = (currentIndex + 1) % Product.Images.Count;
    }

    private void PrevImage()
    {
        if (Product?.Images == null || !Product.Images.Any()) return;
        currentIndex = (currentIndex - 1 + Product.Images.Count) % Product.Images.Count;
    }
}
