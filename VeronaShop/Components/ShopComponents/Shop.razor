@page "/shop"
@using Microsoft.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore.Infrastructure
@using VeronaShop.Data
@using System.Globalization
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject VeronaShop.Services.CartService CartService
@inject VeronaShop.Services.CartSessionService CartSession
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@using MudBlazor
@using VeronaShop.Components.ProductComponents

<MudContainer Class="mt-6">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">Shop</MudText>
        <AuthorizeView Roles="Admin">
            <Authorized>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@NavigateToAdminProducts">Manage products</MudButton>
            </Authorized>
        </AuthorizeView>
    </div>

    @if (!string.IsNullOrEmpty(loadError))
    {
        <MudAlert Severity="Severity.Error">@loadError</MudAlert>
    }
    else if (products == null)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudGrid GutterSize="GutterSize.Small">
            @foreach (var p in products)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="h-100" Style="cursor:default">
                        <div style="height:180px;overflow:hidden;cursor:pointer;" @onclick="() => OpenQuickView(p)">
                            <img src="@GetImage(p)" style="width:100%;height:180px;object-fit:cover" />
                        </div>
                    <MudCardContent @onclick="() => OpenQuickView(p)" Style="cursor:pointer">
                            <MudText Typo="Typo.h6">@p.Name</MudText>
                            <MudText Typo="Typo.body2" Class="mb-2">@p.Description</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">@string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", p.Price)</MudText>
                        </MudCardContent>
                        <MudCardActions Class="d-flex justify-space-between">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(async () => await AddToCart(p.Id))">Add to cart</MudButton>
                            <AuthorizeView Roles="Admin">
                                <Authorized>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="@( () => NavigateToEditProduct(p.Id) )">Edit</MudButton>
                                </Authorized>
                            </AuthorizeView>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    private List<VeronaShop.Data.Entites.Product> products;
    private string loadError;

    private void NavigateToAdminProducts()
    {
        Navigation.NavigateTo("/admin/products");
    }

    private void NavigateToEditProduct(int id)
    {
        Navigation.NavigateTo($"/admin/products?edit={id}");
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var db = DbFactory.CreateDbContext();
            // Load products first without joining ProductImages. The ProductImages table may not exist until migrations are applied.
            products = await db.Products.OrderByDescending(p => p.CreatedAt).ToListAsync();

            try
            {
                // attempt to load images if the table exists; if not, this will throw and we'll ignore images.
                var productIds = products.Select(p => p.Id).ToList();
                var imgs = await db.ProductImages.Where(pi => productIds.Contains(pi.ProductId)).ToListAsync();
                var lookup = imgs.GroupBy(i => i.ProductId).ToDictionary(g => g.Key, g => g.OrderBy(i => i.SortOrder).ToList());
                foreach (var p in products)
                {
                    if (lookup.TryGetValue(p.Id, out var list))
                        p.Images = list;
                }
            }
            catch (Exception imgEx)
            {
                // If ProductImages table is missing or another error occurs, continue without images.
                Console.Error.WriteLine("ProductImages not available: " + imgEx.Message);
            }
        }
        catch (Exception ex)
        {
            loadError = "Unable to load products. Please check your database connection or try again later.";
            Console.Error.WriteLine(ex);
        }
    }

    private async Task AddToCart(int productId)
    {
        try
        {
            var p = products.FirstOrDefault(x => x.Id == productId);
            if (p != null && !string.IsNullOrWhiteSpace(p.SizesCsv))
            {
                await OpenQuickView(p);
                return;
            }

            var sessionId = await CartSession.GetOrCreateSessionIdAsync();
            var cart = await CartService.GetOrCreateCartAsync(sessionId);
            await CartService.AddToCartAsync(cart, productId, 1);
            Snackbar.Add("Added to cart", Severity.Success);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"AddToCart failed: {ex}");
            Snackbar.Add("Failed to add to cart", Severity.Error);
        }
    }

    private string GetImage(VeronaShop.Data.Entites.Product p)
    {
        if (p == null) return "images/placeholder.svg";
        if (p.Images != null && p.Images.Any())
        {
            // shuffle by picking a random image each render
            var rnd = new Random();
            return p.Images.OrderBy(i => rnd.Next()).First().Url;
        }
        return string.IsNullOrEmpty(p.ImageUrl) ? "images/placeholder.svg" : p.ImageUrl;
    }

    private async Task OpenQuickView(VeronaShop.Data.Entites.Product p)
    {
        var parameters = new DialogParameters { ["Product"] = p };
        var options = new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true };
        var dialog = DialogService.Show<ProductQuickView>(string.Empty, parameters, options);
        await dialog.Result; 
    }

    [Inject] IDialogService DialogService { get; set; }
}
