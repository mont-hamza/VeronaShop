@page "/account/register"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using VeronaShop.Data
@using VeronaShop.Models
@using VeronaShop.Data.Entites
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject VeronaShop.Services.IEmailSender EmailSender
@inject IJSRuntime JSRuntime
@inject RoleManager<IdentityRole<int>> RoleManager
@using Microsoft.Extensions.Logging
@inject ILogger<Register> Logger
@using MudBlazor
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L

<MudPaper Class="pa-6 mx-auto" Style="max-width:560px;">
    <MudText Typo="Typo.h5" Class="mb-3">@L["Register"]</MudText>
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <MudAlert Severity="Severity.Info" Elevation="0" Class="mb-2">@statusMessage</MudAlert>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Elevation="0" Class="mb-2">@errorMessage</MudAlert>
    }
    <EditForm Model="registerModel" OnValidSubmit="HandleRegister" FormName="RegisterForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="registerModel.FirstName" Label="@L["FirstName"]" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="registerModel.LastName" Label="@L["LastName"]" Required="true" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="registerModel.UserName" Label="@L["Username"]" Required="true" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="registerModel.Email" Label="@L["Email"]" Required="true" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="registerModel.Phone" Label="@L["Phone"]" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="registerModel.Password" Label="@L["Password"]" InputType="InputType.Password" Required="true" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="registerModel.Address" Label="@L["Address"]" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="registerModel.City" Label="@L["City"]" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="registerModel.Region" Label="@L["Region"]" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="registerModel.Country" Label="@L["Country"]" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudDatePicker @bind-Date="registerModel.DateOfBirth" Label="@L["DateOfBirth"]" />
            </MudItem>

            <MudItem xs="12" Class="d-flex justify-end mt-4">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">@L["Register"]</MudButton>
                
            </MudItem>
        </MudGrid>

    </EditForm>
</MudPaper>

@code {
private RegisterModel registerModel = new RegisterModel();

private string errorMessage;
    private string statusMessage;

    private async Task HandleRegister()
    {
        try { Logger.LogInformation("HandleRegister invoked for {User}", registerModel?.UserName); } catch { }
        statusMessage = L["SubmittingRegistration"];
        StateHasChanged();
        var user = new VeronaShop.Data.ApplicationUser
        {
            UserName = registerModel.UserName,
            Email = registerModel.Email,
                PhoneNumber = registerModel.Phone,
            DisplayName = registerModel.DisplayName ?? registerModel.UserName,
            FirstName = registerModel.FirstName,
            LastName = registerModel.LastName,
            Address = registerModel.Address,
            City = registerModel.City,
            Region = registerModel.Region,
            Country = registerModel.Country,
            DateOfBirth = registerModel.DateOfBirth,
            EmailConfirmed = false
        };

        var result = await UserManager.CreateAsync(user, registerModel.Password);
        if (result.Succeeded)
        {
            statusMessage = L["UserCreated"];
            StateHasChanged();
            // create Customer record
            var customer = new VeronaShop.Data.Entites.Customer
            {
                Name = registerModel.DisplayName ?? registerModel.UserName,
                Email = registerModel.Email,
                Phone = registerModel.Phone ?? string.Empty,
                Address = registerModel.Address ?? string.Empty,
                City = registerModel.City ?? string.Empty,
                Region = registerModel.Region ?? string.Empty,
                Country = registerModel.Country ?? string.Empty,
                DateOfBirth = registerModel.DateOfBirth,
                CreatedAt = DateTimeOffset.UtcNow
            };
            // Use a short-lived DbContext for writes from Blazor component
            using (var db = DbFactory.CreateDbContext())
            {
                db.Customers.Add(customer);
                await db.SaveChangesAsync();

                // link customer to identity user
                customer.IdentityUserId = user.Id;
                db.Customers.Update(customer);
                await db.SaveChangesAsync();
            }
            // assign default role (ensure role exists)
            try
            {
                var roleName = "Customer";
                if (!await RoleManager.RoleExistsAsync(roleName))
                {
                    await RoleManager.CreateAsync(new IdentityRole<int>(roleName));
                }
                await UserManager.AddToRoleAsync(user, roleName);
            }
            catch (Exception ex)
            {
                try { Logger.LogWarning(ex, "Failed to assign Customer role to {User}", user.UserName); } catch { }
            }
            // Send confirmation email with token/link
            try
            {
                var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
                var encoded = System.Net.WebUtility.UrlEncode(code);
                var callbackUrl = Navigation.ToAbsoluteUri($"/account/confirm?userId={user.Id}&code={encoded}").ToString();
                var body = $"<p>Please confirm your account by clicking <a href='{callbackUrl}'>here</a>.</p><p>Or use this code: <b>{System.Net.WebUtility.HtmlEncode(code)}</b></p>";
                await EmailSender.SendEmailAsync(user.Email, L["ConfirmEmailSubject"], body);
                Snackbar.Add(L["ConfirmationEmailSent"], Severity.Info);
            }
            catch (Exception ex)
            {
                try { Logger.LogWarning(ex, "Failed to send confirmation email for {User}", user.UserName); } catch { }
                Snackbar.Add(L["ConfirmationEmailFailed"], Severity.Warning);
            }

            Navigation.NavigateTo($"/account/confirm?userId={user.Id}");
            return;
        }
        else
        {
            var errs = string.Join("; ", result.Errors.Select(e => e.Description));
            Console.Error.WriteLine($"User creation failed: {errs}");
            errorMessage = errs;
            statusMessage = L["RegistrationFailed"];
            try { Logger.LogWarning("User creation failed: {Errors}", errs); } catch { }
        }

        try { Logger.LogInformation("HandleRegister finished for {User}", registerModel?.UserName); } catch { }
    }
}
