@page "/account/orders"
@attribute [Authorize]

@using Microsoft.EntityFrameworkCore
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@using MudBlazor
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>My Orders</PageTitle>

<div class="orders-page">
    <h3>My Orders</h3>

    <div class="d-flex align-center mb-3" style="gap:12px;flex-wrap:wrap">
        <div class="d-flex" style="gap:8px;align-items:center">
            <MudText Typo="Typo.subtitle2">Filter:</MudText>
            @foreach (var s in Enum.GetValues(typeof(OrderStatus)).Cast<OrderStatus>())
            {
                <MudChip T="OrderStatus" OnClick="@(()=>ToggleStatusFilter(s))" Color="@(selectedStatus == s ? GetChipColor(s) : Color.Default)" Variant="@(selectedStatus == s ? Variant.Filled : Variant.Outlined)">@s</MudChip>
            }
            <MudButton Variant="Variant.Text" OnClick="ClearFilter">Clear</MudButton>
        </div>

        <div style="margin-left:auto" class="d-flex align-center" >
            <MudSelect T="string" Value="sortBy" ValueChanged="@( (string v) => { sortBy = v; RefreshView(); } )" Dense="true" Style="min-width:160px">
                <MudSelectItem T="string" Value="@("date_desc")">Newest</MudSelectItem>
                <MudSelectItem T="string" Value="@("date_asc")">Oldest</MudSelectItem>
                <MudSelectItem T="string" Value="@("total_desc")">Total (High)</MudSelectItem>
                <MudSelectItem T="string" Value="@("total_asc")">Total (Low)</MudSelectItem>
            </MudSelect>
            <MudSelect T="int" Value="pageSize" ValueChanged="@( (int v) => { pageSize = v; page = 0; RefreshView(); } )" Dense="true" Style="min-width:100px;margin-left:12px">
                <MudSelectItem T="int" Value="6">6</MudSelectItem>
                <MudSelectItem T="int" Value="9">9</MudSelectItem>
                <MudSelectItem T="int" Value="12">12</MudSelectItem>
            </MudSelect>
        </div>
    </div>

    @if (orders == null)
    {
        <p>Loading...</p>
    }
    else if (!orders.Any())
    {
        <p>You have no orders yet.</p>
    }
    else
    {
        <MudGrid GutterSize="GutterSize.Small">
            @foreach (var o in GetPagedOrders())
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Class="customer-order-card">
                        <MudCardContent>
                            <div class="d-flex justify-space-between">
                                <div class="d-flex" style="gap:12px;align-items:center">
                                    <img src="@(GetProductImageForOrder(o))" style="width:64px;height:64px;object-fit:cover;border-radius:6px" />
                                    <div>
                                        <MudText Typo="Typo.h6">@o.OrderNumber</MudText>
                                        <MudText Typo="Typo.caption">Placed: @o.OrderDate.ToLocalTime().ToString("g")</MudText>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <MudText Typo="Typo.subtitle1" Class="mb-1">@o.TotalAmount.ToString("C")</MudText>
                                    <MudChip T="string" Color="@(GetChipColor(o.Status))" Variant="Variant.Filled">@o.Status</MudChip>
                                </div>
                            </div>

                            <MudDivider Class="my-2" />

                            <div class="order-items-compact">
                                @foreach (var it in o.OrderProducts.Take(3))
                                {
                                    <div class="d-flex justify-space-between"><div>@it.ProductName</div><div class="muted">@it.Quantity x @it.UnitPrice.ToString("C")</div></div>
                                }
                                @if (o.OrderProducts.Count > 3)
                                {
                                    <div class="muted">and @((o.OrderProducts.Count) - 3) more items...</div>
                                }
                            </div>

                            <div class="d-flex justify-space-between align-center mt-3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(() => GoToOrder(o.Id))">View details</MudButton>
                                <div class="d-flex" style="gap:8px;">
                                    <MudButton Variant="Variant.Text" OnClick="@(() => GoToOrderPrint(o.Id))">Print</MudButton>
                                    <MudButton Variant="Variant.Text" OnClick="@(() => DownloadInvoiceById(o.Id))">Download</MudButton>
                                </div>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
        <div class="d-flex justify-space-between align-center mt-3">
            <MudButton Disabled="@(page==0)" OnClick="@( () => { PrevPage(); StateHasChanged(); } )">Previous</MudButton>
            <MudText Typo="Typo.caption">Page @(page+1) of @TotalPages</MudText>
            <MudButton Disabled="@(page>=TotalPages-1)" OnClick="@( () => { NextPage(); StateHasChanged(); } )">Next</MudButton>
        </div>
    }
</div>

@code {
    private List<Orders>? orders;
    private List<Orders> viewOrders = new();
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; }
    private OrderStatus? selectedStatus = null;
    private string sortBy = "date_desc";
    private int page = 0;
    private int pageSize = 6;

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(viewOrders.Count / (double)pageSize));

    private IEnumerable<Orders> GetPagedOrders()
    {
        RefreshView();
        return viewOrders.Skip(page * pageSize).Take(pageSize);
    }

    private void PrevPage()
    {
        page = Math.Max(0, page - 1);
    }

    private void NextPage()
    {
        page = Math.Min(TotalPages - 1, page + 1);
    }

    private string GetProductImageForOrder(Orders o)
    {
        var first = o.OrderProducts.FirstOrDefault();
        if (first != null)
        {
            try
            {
                using var db = DbFactory.CreateDbContext();
                var prod = db.Products.Include(p => p.Images).FirstOrDefault(p => p.Id == first.ProductId);
                if (prod != null)
                {
                    var img = prod.Images.OrderBy(i => i.SortOrder).FirstOrDefault();
                    if (img != null) return img.Url;
                    if (!string.IsNullOrEmpty(prod.ImageUrl)) return prod.ImageUrl;
                }
            }
            catch { }
        }
        return "images/placeholder.svg";
    }

    private Color GetChipColor(OrderStatus s)
    {
        return s switch
        {
            OrderStatus.Pending => Color.Warning,
            OrderStatus.Processing => Color.Info,
            OrderStatus.Shipped => Color.Primary,
            OrderStatus.Delivered => Color.Success,
            OrderStatus.Cancelled => Color.Error,
            _ => Color.Default,
        };
    }

    private void GoToOrder(int id)
    {
        Navigation.NavigateTo($"/account/orders/{id}");
    }

    private void GoToOrderPrint(int id)
    {
        Navigation.NavigateTo($"/account/orders/{id}?print=true");
    }

    private void DownloadInvoiceById(int id)
    {
        Navigation.NavigateTo($"/api/invoices/{id}.pdf", true);
    }

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        if (user?.Identity?.IsAuthenticated != true) return;

        var appUser = await UserManager.GetUserAsync(user);
        if (appUser == null) return;

        using var db = DbFactory.CreateDbContext();
        orders = await db.Orders
            .Where(o => o.Customer != null && o.Customer.IdentityUserId == appUser.Id)
            .Include(o => o.OrderProducts)
            .ToListAsync();
        // initialize client-side view
        viewOrders = orders.OrderByDescending(o => o.OrderDate).ToList();
    }

    private void ToggleStatusFilter(OrderStatus s)
    {
        if (selectedStatus == s) selectedStatus = null; else selectedStatus = s;
        RefreshView();
    }

    private void ClearFilter()
    {
        selectedStatus = null;
        RefreshView();
    }

    private void RefreshView()
    {
        if (orders == null) return;
        var q = orders.AsEnumerable();
        if (selectedStatus.HasValue) q = q.Where(o => o.Status == selectedStatus.Value);
        q = sortBy switch
        {
            "date_asc" => q.OrderBy(o => o.OrderDate),
            "date_desc" => q.OrderByDescending(o => o.OrderDate),
            "total_asc" => q.OrderBy(o => o.TotalAmount),
            "total_desc" => q.OrderByDescending(o => o.TotalAmount),
            _ => q.OrderByDescending(o => o.OrderDate),
        };
        viewOrders = q.ToList();
    }
}
