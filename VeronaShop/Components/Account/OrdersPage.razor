@page "/account/orders"
@attribute [Authorize]

@using Microsoft.EntityFrameworkCore
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@using MudBlazor
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>@L["MyOrdersTitle"]</PageTitle>

<div class="orders-page">
    <h3>@L["MyOrdersTitle"]</h3>

    <div class="d-flex align-center mb-3" style="gap:12px;flex-wrap:wrap">
        <div class="d-flex" style="gap:8px;align-items:center">
            <MudText Typo="Typo.subtitle2">@L["Filter"]:</MudText>
            @foreach (var s in Enum.GetValues(typeof(OrderStatus)).Cast<OrderStatus>())
            {
                <MudChip T="OrderStatus" OnClick="@(()=>ToggleStatusFilter(s))" Color="@(selectedStatus == s ? GetChipColor(s) : Color.Default)" Variant="@(selectedStatus == s ? Variant.Filled : Variant.Outlined)">@s</MudChip>
            }
            <MudButton Variant="Variant.Text" OnClick="ClearFilter">@L["Clear"]</MudButton>
        </div>

        <div style="margin-left:auto" class="d-flex align-center" >
            <MudSelect T="string" Value="sortBy" ValueChanged="@( (string v) => { sortBy = v; RefreshView(); } )" Dense="true" Style="min-width:160px">
                <MudSelectItem T="string" Value="@("date_desc")">Newest</MudSelectItem>
                <MudSelectItem T="string" Value="@("date_asc")">Oldest</MudSelectItem>
                <MudSelectItem T="string" Value="@("total_desc")">Total (High)</MudSelectItem>
                <MudSelectItem T="string" Value="@("total_asc")">Total (Low)</MudSelectItem>
            </MudSelect>
            <MudSelect T="int" Value="pageSize" ValueChanged="@( (int v) => { pageSize = v; page = 0; RefreshView(); } )" Dense="true" Style="min-width:100px;margin-left:12px">
                <MudSelectItem T="int" Value="6">6</MudSelectItem>
                <MudSelectItem T="int" Value="9">9</MudSelectItem>
                <MudSelectItem T="int" Value="12">12</MudSelectItem>
            </MudSelect>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex mt-6" style="justify-content:center">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Medium" />
        </div>
    }
    else if (!string.IsNullOrEmpty(loadError))
    {
        <MudAlert Severity="Severity.Error">@L["LoadOrdersError"]: @loadError</MudAlert>
    }
    else if (totalOrders == 0)
    {
        <p>@L["NoOrdersYet"]</p>
    }
    else
    {
        <div class="mb-2">
            <MudText Typo="Typo.caption">@L["ShowingPage"] @(page+1) — @totalOrders @L["OrdersLabel"]</MudText>
        </div>
        <MudGrid GutterSize="GutterSize.Small">
            @foreach (var o in serverOrders)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Class="customer-order-card">
                        <MudCardContent>
                            <div class="d-flex justify-space-between">
                                <div class="d-flex" style="gap:12px;align-items:center">
                                    <img src="@(GetProductImageForOrder(o))" style="width:64px;height:64px;object-fit:cover;border-radius:6px" />
                                    <div>
                                        <MudText Typo="Typo.h6">@o.OrderNumber</MudText>
                                        <MudText Typo="Typo.caption">@L["Placed"]: @o.OrderDate.ToLocalTime().ToString("g")</MudText>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <MudText Typo="Typo.subtitle1" Class="mb-1">@o.TotalAmount.ToString("C")</MudText>
                                    <MudChip T="string" Color="@(GetChipColor(o.Status))" Variant="Variant.Filled">@o.Status</MudChip>
                                </div>
                            </div>

                            <MudDivider Class="my-2" />

                            <div class="order-items-compact">
                                @foreach (var it in o.OrderProducts.Take(3))
                                {
                                    <div class="d-flex justify-space-between"><div>@it.ProductName</div><div class="muted">@it.Quantity x @it.UnitPrice.ToString("C")</div></div>
                                }
                                @if (o.OrderProducts.Count > 3)
                                {
                                    <div class="muted">@string.Format(L["AndNMoreItems"], (o.OrderProducts.Count) - 3)</div>
                                }
                            </div>

                            <div class="d-flex justify-space-between align-center mt-3">
                                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(() => GoToOrder(o.Id))">@L["ViewDetails"]</MudButton>
                                
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
        <div class="d-flex justify-space-between align-center mt-3">
            <MudButton Disabled="@(page==0)" OnClick="@( () => { PrevPage(); StateHasChanged(); } )">@L["Previous"]</MudButton>
            <MudText Typo="Typo.caption">@string.Format(L["PageOf"], page+1, TotalPages)</MudText>
            <MudButton Disabled="@(page>=TotalPages-1)" OnClick="@( () => { NextPage(); StateHasChanged(); } )">@L["Next"]</MudButton>
        </div>
    }
</div>

@code {
    private List<Orders>? orders;
    private List<Orders> viewOrders = new();
    private List<Orders> serverOrders = new();
    private bool isLoading = false;
    private int totalOrders = 0;
    private string? loadError;
    private bool hasProductImagesChecked = false;
    private bool hasProductImages = false;
    private Dictionary<int, Product> productLookup = new();
    [Inject] private VeronaShop.Services.OrdersPrefetchService PrefetchService { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; }
    private OrderStatus? selectedStatus = null;
    private string sortBy = "date_desc";
    private int page = 0;
    private int pageSize = 6;

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(viewOrders.Count / (double)pageSize));

    private IEnumerable<Orders> GetPagedOrders()
    {
        // server-side paging uses serverOrders
        return serverOrders;
    }

    private void PrevPage()
    {
        if (page == 0) return;
        page = Math.Max(0, page - 1);
        _ = LoadPageAsync();
    }

    private void NextPage()
    {
        if ((page+1) * pageSize >= totalOrders) return;
        page = Math.Min(TotalPages - 1, page + 1);
        _ = LoadPageAsync();
    }

    private string GetProductImageForOrder(Orders o)
    {
        var first = o.OrderProducts.FirstOrDefault();
        if (first != null)
        {
            // Use productLookup cache populated during initialization
            if (productLookup.TryGetValue(first.ProductId, out var prod))
            {
                var img = prod.Images?.OrderBy(i => i.SortOrder).FirstOrDefault();
                if (img != null && !string.IsNullOrEmpty(img.Url)) return img.Url;
            }
        }
        return "/images/placeholder.svg";
    }

    private Color GetChipColor(OrderStatus s)
    {
        return s switch
        {
            OrderStatus.Pending => Color.Warning,
            OrderStatus.Processing => Color.Info,
            OrderStatus.Shipped => Color.Primary,
            OrderStatus.Delivered => Color.Success,
            OrderStatus.Cancelled => Color.Error,
            _ => Color.Default,
        };
    }

    private void GoToOrder(int id)
    {
        Navigation.NavigateTo($"/account/orders/{id}");
    }

    private void GoToOrderPrint(int id)
    {
        Navigation.NavigateTo($"/account/orders/{id}?print=true");
    }

    private void DownloadInvoiceById(int id)
    {
        Navigation.NavigateTo($"/api/invoices/{id}.pdf", true);
    }

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        if (user?.Identity?.IsAuthenticated != true) return;

        var appUser = await UserManager.GetUserAsync(user);
        if (appUser == null) return;

        try
        {
            using var db = DbFactory.CreateDbContext();
            // preload product and image data to avoid per-order DB calls later
            hasProductImages = await db.TableExistsAsync("ProductImages");
            hasProductImagesChecked = true;

            // Try to find the linked customer record first (by IdentityUserId or email) to ensure we locate orders
            var linkedCustomer = await db.Customers.FirstOrDefaultAsync(c => c.IdentityUserId == appUser.Id || c.Email == appUser.Email);
            IQueryable<Orders> baseQuery = db.Orders.Where(o => o.Customer != null);
            if (linkedCustomer != null)
            {
                baseQuery = baseQuery.Where(o => o.CustomerId == linkedCustomer.Id);
            }
            else
            {
                // fallback to matching by IdentityUserId on the joined customer if any
                baseQuery = baseQuery.Where(o => o.Customer != null && o.Customer.IdentityUserId == appUser.Id);
            }

            // server-side paging: get total count and fetch page
            totalOrders = await baseQuery.CountAsync();
            var q = baseQuery.OrderByDescending(o => o.OrderDate).Skip(page * pageSize).Take(pageSize).Include(o => o.OrderProducts);
            isLoading = true;
            StateHasChanged();
            var pageOrders = await q.AsSplitQuery().ToListAsync();
            isLoading = false;

            serverOrders = pageOrders;

            // Load referenced products for the page
            var productIds = serverOrders.SelectMany(o => o.OrderProducts).Select(op => op.ProductId).Distinct().ToList();
            if (productIds.Any())
            {
                var prodsQuery = db.Products.Where(p => productIds.Contains(p.Id));
                if (hasProductImages)
                    prodsQuery = prodsQuery.Include(p => p.Images);

                var prods = await prodsQuery.ToListAsync();
                productLookup = prods.ToDictionary(p => p.Id, p => p);
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
            orders = new List<Orders>();
        }

        // initialize server-side page
        await LoadPageAsync();
    }

    private async Task ToggleStatusFilter(OrderStatus s)
    {
        if (selectedStatus == s) selectedStatus = null; else selectedStatus = s;
        page = 0;
        await LoadPageAsync();
    }

    private async Task ClearFilter()
    {
        selectedStatus = null;
        page = 0;
        await LoadPageAsync();
    }

    // refresh client-side view and run a small animation
    private bool animateGrid = false;
    private async Task RefreshView()
    {
        // For server-side paging this is now a no-op; reset page and reload
        page = 0;
        await LoadPageAsync();
        // trigger CSS animation class for a short time
        animateGrid = true;
        StateHasChanged();
        await Task.Delay(280);
        animateGrid = false;
        StateHasChanged();
    }

    private async Task LoadPageAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        if (user?.Identity?.IsAuthenticated != true) return;

        var appUser = await UserManager.GetUserAsync(user);
        if (appUser == null) return;

        // try prefetch cache first
        try
        {
            if (PrefetchService != null && PrefetchService.TryGetPrefetch(appUser.Id, page, pageSize, sortBy, selectedStatus, out var pOrders, out var pLookup, out var pTotal))
            {
                serverOrders = pOrders;
                productLookup = pLookup.ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
                totalOrders = pTotal;
                StateHasChanged();
                return;
            }
        }
        catch { }

        try
        {
            using var db = DbFactory.CreateDbContext();
            hasProductImages = await db.TableExistsAsync("ProductImages");
            hasProductImagesChecked = true;

            var linkedCustomer = await db.Customers.FirstOrDefaultAsync(c => c.IdentityUserId == appUser.Id || c.Email == appUser.Email);
            IQueryable<Orders> baseQuery = db.Orders.Where(o => o.Customer != null);
            if (linkedCustomer != null)
                baseQuery = baseQuery.Where(o => o.CustomerId == linkedCustomer.Id);
            else
                baseQuery = baseQuery.Where(o => o.Customer != null && o.Customer.IdentityUserId == appUser.Id);

            totalOrders = await baseQuery.CountAsync();
            var q = baseQuery.OrderByDescending(o => o.OrderDate).Skip(page * pageSize).Take(pageSize).Include(o => o.OrderProducts);
            isLoading = true;
            StateHasChanged();
            serverOrders = await q.AsSplitQuery().ToListAsync();
            isLoading = false;

            var productIds = serverOrders.SelectMany(o => o.OrderProducts).Select(op => op.ProductId).Distinct().ToList();
            if (productIds.Any())
            {
                var prodsQuery = db.Products.Where(p => productIds.Contains(p.Id));
                if (hasProductImages) prodsQuery = prodsQuery.Include(p => p.Images);
                var prods = await prodsQuery.ToListAsync();
                productLookup = prods.ToDictionary(p => p.Id, p => p);
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        StateHasChanged();
    }
}
