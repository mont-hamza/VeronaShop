@page "/account/orders/{orderId:int}"
@using Microsoft.EntityFrameworkCore
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Localization
@using MudBlazor
@inject IStringLocalizer<SharedResources> L
@inject ISnackbar Snackbar

<PageTitle>@L["OrderDetailsTitle"]</PageTitle>

<MudContainer Class="mt-4">
    @if (order == null)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudPaper Class="pa-4 mb-4">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.h5">@L["Order"] @order.OrderNumber</MudText>
                    <MudText Typo="Typo.body2" Class="mt-1">@L["Placed"]: @order.OrderDate.ToLocalTime().ToString("f")</MudText>
                    <MudText Typo="Typo.body2">@L["Total"]: @($"LYD {order.TotalAmount:N2}")</MudText>
                </div>
                <div class="d-flex" style="gap:8px;align-items:center;">
                    <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled">@order.Status.ToString()</MudChip>
                    @* Action buttons temporarily hidden
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="PrintInvoice" StartIcon="@Icons.Material.Filled.Print">@L["Print"]</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="DownloadInvoice" StartIcon="@Icons.Material.Filled.Download">@L["DownloadPDF"]</MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="EmailInvoice" StartIcon="@Icons.Material.Filled.Email">@L["EmailInvoice"]</MudButton>
                    *@
                </div>
            </div>
        </MudPaper>

        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-2">@L["Items"]</MudText>
            <MudTable Dense="true" Hover="true" Bordered="false" Striped="true" Items="order.OrderProducts">
                <HeaderContent>
                    <MudTh></MudTh>
                    <MudTh>@L["Product"]</MudTh>
                    <MudTh align="Align.Right">@L["Price"]</MudTh>
                    <MudTh align="Align.Right">@L["Quantity"]</MudTh>
                    <MudTh>@L["Size"]</MudTh>
                    <MudTh align="Align.Right">@L["Line"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd><img src="@GetImageUrl(context)" style="width:64px;height:64px;object-fit:cover;border-radius:6px;" /></MudTd>
                    <MudTd>@context.ProductName</MudTd>
                    <MudTd Align="Align.Right">@($"LYD {context.UnitPrice:N2}")</MudTd>
                    <MudTd Align="Align.Right">@context.Quantity</MudTd>
                    <MudTd>@context.SizeName</MudTd>
                    <MudTd Align="Align.Right">@($"LYD {(context.UnitPrice * context.Quantity):N2}")</MudTd>
                </RowTemplate>
            </MudTable>

            <div class="d-flex justify-end mt-3">
                <MudPaper Class="pa-3" Style="min-width:260px;">
                    <div class="d-flex justify-space-between">
                        <MudText>@L["Subtotal"]</MudText>
                        <MudText>@($"LYD {order.OrderProducts.Sum(x => x.UnitPrice * x.Quantity):N2}")</MudText>
                    </div>
                    <div class="d-flex justify-space-between mt-1">
                        <MudText>@L["Shipping"]</MudText>
                        <MudText>@($"LYD {order.ShippingCost:N2}")</MudText>
                    </div>
                    <MudDivider Class="my-2" />
                    <div class="d-flex justify-space-between">
                        <MudText Typo="Typo.subtitle1">@L["Total"]</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">@($"LYD {order.TotalAmount:N2}")</MudText>
                    </div>
                </MudPaper>
            </div>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public int orderId { get; set; }
    private Orders? order;
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; }
    private bool shouldPrintAfterRender = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (shouldPrintAfterRender)
        {
            shouldPrintAfterRender = false;
            await PrintInvoice();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        if (user?.Identity?.IsAuthenticated != true) return;

        using var db = DbFactory.CreateDbContext();
        order = await db.Orders.Include(o => o.OrderProducts).ThenInclude(op => op.Product).ThenInclude(p => p.Images).FirstOrDefaultAsync(o => o.Id == orderId);
        if (order == null)
        {
            Navigation.NavigateTo("/account/orders");
        }

        // if ?print=true in query, set flag to print after render (JS interop allowed)
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var q = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (q["print"] == "true")
        {
            shouldPrintAfterRender = true;
        }
    }

    [Inject] private IJSRuntime JS { get; set; }

    private async Task PrintInvoice()
    {
        await JS.InvokeVoidAsync("window.print");
    }

    private async Task DownloadInvoice()
    {
        // download PDF by calling server endpoint
        var url = $"/api/invoices/{order.Id}.pdf";
        Navigation.NavigateTo(url, true);
    }

    private async Task EmailInvoice()
    {
        var to = order.Customer?.Email ?? string.Empty;
        try
        {
            var client = new System.Net.Http.HttpClient();
            var res = await client.PostAsJsonAsync($"/api/invoices/{order.Id}/email", new { To = to });
            if (res.IsSuccessStatusCode)
            {
                Snackbar.Add(L["InvoiceEmailed"], Severity.Success);
            }
            else
            {
                Snackbar.Add(L["FailedEmailInvoice"], Severity.Error);
            }
        }
        catch { }
    }

    private string GetImageUrl(OrderProduct op)
    {
        try
        {
            if (op?.Product?.Images != null && op.Product.Images.Any())
                return op.Product.Images.OrderBy(i => i.SortOrder).First().Url;
            if (!string.IsNullOrEmpty(op?.Product?.ImageUrl))
                return op.Product.ImageUrl;
        }
        catch { }
        return "/images/placeholder.svg";
    }
}
