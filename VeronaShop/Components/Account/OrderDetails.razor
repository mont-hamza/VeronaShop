@page "/account/orders/{orderId:int}"
@using Microsoft.EntityFrameworkCore
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResources> L
@inject ISnackbar Snackbar

<PageTitle>@L["OrderDetailsTitle"]</PageTitle>

<div class="order-details-page">
    @if (order == null)
    {
        <p>@L["Loading"]</p>
    }
    else
    {
        <h3>@L["Order"] @order.OrderNumber</h3>
        <div><strong>@L["Placed"]</strong> @order.OrderDate.ToLocalTime().ToString("g")</div>
        <div><strong>@L["Status"]</strong> @order.Status.ToString()</div>
        <div><strong>@L["Total"]</strong> @order.TotalAmount.ToString("C")</div>

        <h4>@L["Items"]</h4>
        <div class="order-thumbs">
            @foreach (var it in order.OrderProducts)
            {
                var imgUrl = it.Product?.Images?.OrderBy(i => i.SortOrder).FirstOrDefault()?.Url ?? it.Product?.ImageUrl ?? "/images/placeholder.svg";
                <div>
                    <img class="order-thumb" src="@imgUrl" />
                    <div style="max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:0.9rem">@it.ProductName</div>
                    <div class="muted">@it.Quantity x @it.UnitPrice.ToString("C")</div>
                </div>
            }
        </div>

        <div style="margin-top:12px">
            <button class="mud-button-root mud-button" @onclick="PrintInvoice">@L["Print"]</button>
            <button class="mud-button-root mud-button" @onclick="DownloadInvoice">@L["DownloadPDF"]</button>
            <button class="mud-button-root mud-button" @onclick="EmailInvoice">@L["EmailInvoice"]</button>
        </div>
    }
</div>

@code {
    [Parameter] public int orderId { get; set; }
    private Orders? order;
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; }
    private bool shouldPrintAfterRender = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (shouldPrintAfterRender)
        {
            shouldPrintAfterRender = false;
            await PrintInvoice();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        if (user?.Identity?.IsAuthenticated != true) return;

        using var db = DbFactory.CreateDbContext();
        order = await db.Orders.Include(o => o.OrderProducts).ThenInclude(op => op.Product).ThenInclude(p => p.Images).FirstOrDefaultAsync(o => o.Id == orderId);
        if (order == null)
        {
            Navigation.NavigateTo("/account/orders");
        }

        // if ?print=true in query, set flag to print after render (JS interop allowed)
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var q = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (q["print"] == "true")
        {
            shouldPrintAfterRender = true;
        }
    }

    [Inject] private IJSRuntime JS { get; set; }

    private async Task PrintInvoice()
    {
        await JS.InvokeVoidAsync("window.print");
    }

    private async Task DownloadInvoice()
    {
        // download PDF by calling server endpoint
        var url = $"/api/invoices/{order.Id}.pdf";
        Navigation.NavigateTo(url, true);
    }

    private async Task EmailInvoice()
    {
        var to = order.Customer?.Email ?? string.Empty;
        try
        {
            var client = new System.Net.Http.HttpClient();
            var res = await client.PostAsJsonAsync($"/api/invoices/{order.Id}/email", new { To = to });
            if (res.IsSuccessStatusCode)
            {
                Snackbar.Add(L["InvoiceEmailed"], Severity.Success);
            }
            else
            {
                Snackbar.Add(L["FailedEmailInvoice"], Severity.Error);
            }
        }
        catch { }
    }
}
