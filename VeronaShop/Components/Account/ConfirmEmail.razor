@page "/account/confirm"
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using System.ComponentModel.DataAnnotations
@using VeronaShop.Data
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole<int>> RoleManager
@inject Microsoft.EntityFrameworkCore.IDbContextFactory<VeronaShop.Data.ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L

<h3>@L["ConfirmEmailTitle"]</h3>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <MudAlert Severity="@statusSeverity" Elevation="0" Class="mb-3">@statusMessage</MudAlert>
}

<EditForm Model="model" OnValidSubmit="HandleConfirm">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <MudTextField @bind-Value="model.UserId" Label="User Id" Required="true" />
    <MudTextField @bind-Value="model.Code" Label="Code" Required="true" />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-3" ButtonType="ButtonType.Submit">@L["Confirm"]</MudButton>
</EditForm>

@code {
    private ConfirmModel model = new();
    private string statusMessage;
    private Severity statusSeverity = Severity.Info;

    public class ConfirmModel
    {
        [Required]
        public string UserId { get; set; }
        [Required]
        public string Code { get; set; }
    }

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("userId", out var uid)) model.UserId = uid.FirstOrDefault();
        if (query.TryGetValue("code", out var code)) model.Code = code.FirstOrDefault();
    }

    private async Task HandleConfirm()
    {
        statusMessage = null;
        var user = await UserManager.FindByIdAsync(model.UserId);
        if (user == null)
        {
            statusMessage = L["InvalidUser"];
            statusSeverity = Severity.Error;
            return;
        }

        var result = await UserManager.ConfirmEmailAsync(user, model.Code);
        if (result.Succeeded)
        {
            // After confirming email, create Customer profile and assign Customer role.
            statusMessage = L["EmailConfirmed"];
            statusSeverity = Severity.Success;
            try
            {
                using var db = DbFactory.CreateDbContext();
                var exists = await db.Customers.FirstOrDefaultAsync(c => c.IdentityUserId == user.Id);
                if (exists == null)
                {
                    var customer = new VeronaShop.Data.Entites.Customer
                    {
                        Name = user.DisplayName ?? user.UserName ?? "Customer",
                        Email = user.Email ?? string.Empty,
                        Phone = user.PhoneNumber ?? string.Empty,
                        Address = user.Address ?? string.Empty,
                        City = user.City ?? string.Empty,
                        Country = user.Country ?? string.Empty,
                        Region = user.Region ?? string.Empty,
                        DateOfBirth = user.DateOfBirth,
                        CreatedAt = DateTimeOffset.UtcNow,
                        IdentityUserId = user.Id
                    };
                    db.Customers.Add(customer);
                    await db.SaveChangesAsync();
                }

                var roleName = "Customer";
                if (!await RoleManager.RoleExistsAsync(roleName))
                {
                    await RoleManager.CreateAsync(new IdentityRole<int>(roleName));
                }
                await UserManager.AddToRoleAsync(user, roleName);
            }
            catch { }
        }
        else
        {
            statusMessage = string.Join("; ", result.Errors.Select(e => e.Description));
            statusSeverity = Severity.Error;
        }
    }
}
