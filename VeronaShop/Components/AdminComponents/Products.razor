@page "/admin/products"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]

<MudPaper Class="pa-4">
<div class="d-flex justify-space-between align-center">
    <h3>@L["ManageProducts"]</h3>
    <MudTextField Placeholder="@L["Search"]" @bind-Value="search" Adornment="Adornment.Start" AdornmentIcon="Icons.Material.Filled.Search" Class="mr-2" />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateNew" Class="ml-2">@L["AddProduct"]</MudButton>
</div>

    @if (!string.IsNullOrEmpty(message))
    {
        <MudAlert Severity="Severity.Success" Elevation="0">@message</MudAlert>
    }

    @if (editingProduct != null)
    {
        <MudPaper Class="pa-3 mt-3">
            <EditForm Model="editingProduct" OnValidSubmit="@SaveProduct" FormName="AdminProductForm">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <MudTextField @bind-Value="editingProduct.Name" Label="@L["Name"]" Required="true" />
                <MudTextField @bind-Value="editingProduct.SKU" Label="@L["SKU"]" />
                <div class="mb-2">
                    <label class="mud-input-label">@L["ProductImage"]</label>
                    <div class="d-flex gap-2 align-center">
                        <InputFile OnChange="OnEditInputFileChange" />
                        <MudText Typo="Typo.caption">@L["PickPhoto"]</MudText>
                    </div>
                    @if (!string.IsNullOrEmpty(editingPreviewUrl))
                    {
                        <div class="mt-2">
                            <img src="@editingPreviewUrl" style="max-width:160px;max-height:160px;object-fit:contain;border:1px solid #e0e0e0;padding:6px" />
                        </div>
                    }
                </div>
                <MudTextField @bind-Value="editingProduct.Price" Label="@L["Price"]" InputType="InputType.Number" Required="true" />
                <MudTextField @bind-Value="editingProduct.DiscountPrice" Label="@L["DiscountPrice"]" InputType="InputType.Number" />
                <MudTextField @bind-Value="editingProduct.StockQuantity" Label="@L["StockQuantity"]" InputType="InputType.Number" />
                <MudTextField @bind-Value="editingProduct.SizesCsv" Label="@L["SizesCsvLabel"]" />
                <MudCheckBox T="bool" @bind-Checked="editingProduct.IsPublished">@L["Published"]</MudCheckBox>

                <div class="mt-2">
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">@L["Save"]</MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="@(e => CancelEdit())">@L["Cancel"]</MudButton>
                </div>
            </EditForm>
        </MudPaper>
    }

    <MudTable T="Product" Items="displayedProducts" Dense="true" Hover="true" Class="mt-4">
        <HeaderContent>
            <MudTh>@L["Id"]</MudTh>
            <MudTh>@L["Name"]</MudTh>
            <MudTh>@L["Price"]</MudTh>
            <MudTh>@L["Stock"]</MudTh>
            <MudTh>@L["Category"]</MudTh>
            <MudTh>@L["Supplier"]</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Id">@context.Id</MudTd>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Price">@($"LYD {context.Price:N2}")</MudTd>
            <MudTd DataLabel="Stock">@context.StockQuantity</MudTd>
            <MudTd DataLabel="Category">@context.Category?.Name</MudTd>
            <MudTd DataLabel="Supplier">@context.Supplier?.CompanyName</MudTd>
            <MudTd>
                <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="@(e => Edit(context))">@L["Edit"]</MudButton>
                <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Error" OnClick="@(e => PromptDelete(context))">@L["Delete"]</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>

    <div class="d-flex justify-space-between align-center mt-2">
        <div>Page: @(page + 1)</div>
        <div>
            <MudButton Disabled="@(page == 0)" OnClick="@( () => { page = Math.Max(0, page - 1); })">Previous</MudButton>
            <MudButton Disabled="@(filteredProducts.Count() <= (page + 1) * pageSize)" OnClick="@( () => { page++; })">Next</MudButton>
        </div>
    </div>

    @if (productToDelete != null)
    {
        <MudPaper Class="pa-3 mt-3">
            <p>@string.Format(L["DeleteConfirm"], productToDelete.Name)</p>
            <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="@(e => ConfirmDelete())">@L["Delete"]</MudButton>
            <MudButton Variant="Variant.Text" OnClick="@(e => CancelDelete())">@L["Cancel"]</MudButton>
        </MudPaper>
    }
</MudPaper>

@code {
    private List<Product> products = new();
    private List<Product> filteredProducts = new();
    private string search;
    private Product editingProduct;
    private Product productToDelete;
    private string message;
    private IBrowserFile editingFile;
    private string editingPreviewUrl;

    [Inject] private IDbContextFactory<ApplicationDbContext> DbFactory { get; set; }
    [Inject] private ILogger<Products> Logger { get; set; }
    [Inject] private NavigationManager Nav { get; set; }

    [Inject] IDialogService DialogService { get; set; }
    [Inject] ISnackbar Snackbar { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
        // if navigated with ?edit={id} from shop, open editor immediately
        try
        {
            var uri = new Uri(Nav.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var editVal = query.Get("edit");
            if (!string.IsNullOrEmpty(editVal) && int.TryParse(editVal, out var editId))
            {
                var toEdit = products.FirstOrDefault(p => p.Id == editId);
                if (toEdit != null)
                {
                    Edit(toEdit);
                }
            }
        }
        catch { }
    }

    private async Task LoadProducts()
    {
        using var db = DbFactory.CreateDbContext();
        products = await db.Products.Include(p => p.Category).Include(p => p.Supplier).OrderByDescending(p => p.CreatedAt).ToListAsync();
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(search))
            filteredProducts = products.ToList();
        else
            filteredProducts = products.Where(p => p.Name.Contains(search, StringComparison.OrdinalIgnoreCase) || (p.SKU ?? "").Contains(search, StringComparison.OrdinalIgnoreCase)).ToList();
    }

    // client-side paging/sorting/filtering
    private int page = 0;
    private int pageSize = 10;
    private IEnumerable<Product> displayedProducts => filteredProducts.Skip(page * pageSize).Take(pageSize);

    private void ApplySearch(ChangeEventArgs args)
    {
        search = args?.Value?.ToString();
        ApplyFilter();
    }

    // dialog-based create/edit removed for simplicity; use inline form

    private void CreateNew()
    {
        editingProduct = new Product
        {
            Name = string.Empty,
            SKU = string.Empty,
            ImageUrl = "/images/placeholder.svg",
            Description = string.Empty,
            Price = 0m,
            SizesCsv = string.Empty,
            CreatedAt = DateTimeOffset.UtcNow,
            IsPublished = true
        };
    }

    private void Edit(Product p)
    {
        editingProduct = new Product
        {
            Id = p.Id,
            Name = p.Name,
            SKU = p.SKU,
            Description = p.Description,
            SizesCsv = p.SizesCsv,
            Price = p.Price,
            DiscountPrice = p.DiscountPrice,
            StockQuantity = p.StockQuantity,
            IsPublished = p.IsPublished,
            ImageUrl = p.ImageUrl,
            CategoryId = p.CategoryId,
            SupplierId = p.SupplierId,
            CreatedAt = p.CreatedAt,
            UpdatedAt = p.UpdatedAt
        };
    }

    private void CancelEdit()
    {
        editingProduct = null;
    }

    private async Task OnEditInputFileChange(InputFileChangeEventArgs e)
    {
        editingFile = e.File;
        // validate mime
        if (!editingFile.ContentType.StartsWith("image/"))
        {
            Snackbar.Add(L["OnlyImagesAllowed"], Severity.Error);
            return;
        }
        var buffer = new byte[editingFile.Size];
        await editingFile.OpenReadStream(10 * 1024 * 1024).ReadAsync(buffer);
        editingPreviewUrl = $"data:{editingFile.ContentType};base64,{Convert.ToBase64String(buffer)}";
        editingProduct.ImageUrl = editingPreviewUrl;
    }

    private async Task SaveProduct()
    {
        // perform add or update in a single DbContext and ensure required fields are not null
        editingProduct.Name ??= string.Empty;
        editingProduct.SKU ??= string.Empty;
        editingProduct.Description ??= string.Empty;
        editingProduct.ImageUrl ??= string.Empty;

        // ensure a default image url is present so DB inserts don't fail
        if (string.IsNullOrWhiteSpace(editingProduct.ImageUrl))
        {
            editingProduct.ImageUrl = "/images/placeholder.svg";
        }

        using var db = DbFactory.CreateDbContext();
            string oldImage = string.Empty;
            if (editingProduct.Id == 0)
        {
            editingProduct.CreatedAt = DateTimeOffset.UtcNow;
            db.Products.Add(editingProduct);
        }
        else
        {
            var existing = await db.Products.FindAsync(editingProduct.Id);
            if (existing != null)
            {
                    oldImage = existing.ImageUrl ?? string.Empty;
                    existing.Name = editingProduct.Name ?? string.Empty;
                existing.SKU = editingProduct.SKU ?? string.Empty;
                existing.Description = editingProduct.Description ?? string.Empty;
                existing.Price = editingProduct.Price;
                existing.DiscountPrice = editingProduct.DiscountPrice;
                existing.StockQuantity = editingProduct.StockQuantity;
                existing.IsPublished = editingProduct.IsPublished;
                existing.ImageUrl = editingProduct.ImageUrl ?? string.Empty;
                existing.CategoryId = editingProduct.CategoryId;
                existing.SupplierId = editingProduct.SupplierId;
                existing.SizesCsv = editingProduct.SizesCsv ?? string.Empty;
                existing.UpdatedAt = DateTimeOffset.UtcNow;
                // message assigned after successful save
            }
        }
        try
        {
            // if an image file was selected and preview is a data URL, persist the file to disk
            if (editingFile != null && editingProduct.ImageUrl != null && editingProduct.ImageUrl.StartsWith("data:"))
            {
                // save the image file to wwwroot/uploads/products via ProductDialog logic
                var uploads = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "products");
                Directory.CreateDirectory(uploads);
                var ext = Path.GetExtension(editingFile.Name);
                var fileName = Guid.NewGuid().ToString() + ext;
                var fullPath = Path.Combine(uploads, fileName);
                using var stream = editingFile.OpenReadStream(10 * 1024 * 1024);
                // simple copy; no server resize here for inline editor
                using var fs = File.Create(fullPath);
                await stream.CopyToAsync(fs);
                editingProduct.ImageUrl = $"/uploads/products/{fileName}";
                // update product image url in DB
                if (editingProduct.Id != 0)
                {
                    var existing = await db.Products.FindAsync(editingProduct.Id);
                    if (existing != null)
                    {
                        existing.ImageUrl = editingProduct.ImageUrl;
                        // cleanup old image
                        try
                        {
                            if (!string.IsNullOrEmpty(oldImage) && oldImage.StartsWith("/uploads/products/") && oldImage != editingProduct.ImageUrl)
                            {
                                var physicalOld = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", oldImage.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
                                if (File.Exists(physicalOld)) File.Delete(physicalOld);
                            }
                        }
                        catch { }
                    }
                }
            }

            await db.SaveChangesAsync();
            // success
            editingProduct = null;
            await LoadProducts();
            message = editingProduct == null ? L["ProductSaved"] : L["ProductSaved"];
            Snackbar.Add(message, Severity.Success);
        }
        catch (Exception ex)
        {
            message = L["SaveProductFailed"];
            try { Logger.LogError(ex, "SaveProduct failed"); } catch { }
            Snackbar.Add($"{L["SaveProductFailed"]}: {ex.Message}", Severity.Error);
        }
    }

    private void PromptDelete(Product p)
    {
        productToDelete = p;
    }

    private void CancelDelete()
    {
        productToDelete = null;
    }

    private async Task ConfirmDelete()
    {
        if (productToDelete != null)
        {
            try
            {
                using var db = DbFactory.CreateDbContext();
                var existing = await db.Products.Include(p => p.Images).FirstOrDefaultAsync(p => p.Id == productToDelete.Id);
                if (existing != null)
                {
                    // remove product images rows first to avoid FK constraint issues
                    if (existing.Images != null && existing.Images.Any())
                    {
                        // delete files from disk where possible
                        foreach (var img in existing.Images.ToList())
                        {
                            try
                            {
                                if (!string.IsNullOrEmpty(img.Url) && img.Url.StartsWith("/uploads/products/"))
                                {
                                    var physical = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", img.Url.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
                                    if (File.Exists(physical)) File.Delete(physical);
                                }
                            }
                            catch { }
                        }

                        db.ProductImages.RemoveRange(existing.Images);
                    }

                    db.Products.Remove(existing);
                    await db.SaveChangesAsync();
                    message = L["ProductDeleted"];
                }
            }
            catch (Exception ex)
            {
                try { Logger.LogError(ex, "ConfirmDelete failed"); } catch { }
                Snackbar.Add(L["DeleteProductFailed"], Severity.Error);
            }
            productToDelete = null;
            await LoadProducts();
        }
    }
}
