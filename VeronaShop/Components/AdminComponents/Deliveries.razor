@page "/admin/deliveries"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<MudPaper Class="pa-4">
    <h3>Assign Carrier</h3>
    <MudSelect T="int" Label="Order" @bind-Value="selectedOrderId" Dense="true" Style="min-width:320px">
        @foreach (var o in shippedOrders)
        {
            <MudSelectItem T="int" Value="@o.Id">@o.OrderNumber (@o.Customer?.Name) — @o.OrderDate.ToString("g")</MudSelectItem>
        }
    </MudSelect>
    <MudSelect T="int" Label="Carrier" @bind-Value="selectedCarrierId" Dense="true" Style="min-width:280px" Class="mt-2">
        @foreach (var c in carriers)
        {
            <MudSelectItem T="int" Value="@c.Id">@c.Name (@c.Phone)</MudSelectItem>
        }
    </MudSelect>
    <MudTextField Label="Tracking number" @bind-Value="tracking" Class="mt-2" />
    <div class="mt-3">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(selectedCarrierId==0 || selectedOrderId==0)" OnClick="Assign">Assign</MudButton>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
    </div>
</MudPaper>

@code {
    [Inject] IDbContextFactory<ApplicationDbContext> DbFactory { get; set; }
    [Inject] NavigationManager Nav { get; set; }
    [Inject] ISnackbar Snackbar { get; set; }

    private List<Carrier> carriers = new();
    private List<Orders> shippedOrders = new();
    private int selectedCarrierId;
    private string tracking = string.Empty;
    private int selectedOrderId;

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();
        carriers = await db.Carriers.Where(c => c.IsActive).OrderBy(c => c.Name).ToListAsync();
        shippedOrders = await db.Orders.Include(o=>o.Customer).Where(o => o.Status == OrderStatus.Shipped).OrderByDescending(o=>o.OrderDate).Take(200).ToListAsync();
        // Preselect order from query if provided
        try
        {
            var uri = new Uri(Nav.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var orderId = int.TryParse(query.Get("orderId"), out var id) ? id : 0;
            if (orderId != 0 && shippedOrders.Any(o=>o.Id==orderId))
                selectedOrderId = orderId;
        }
        catch { }
    }

    private async Task Assign()
    {
        using var db = DbFactory.CreateDbContext();
        // Validate order exists to satisfy FK
        var order = await db.Orders.AsNoTracking().FirstOrDefaultAsync(o => o.Id == selectedOrderId);
        if (order == null)
        {
            Snackbar.Add("Order not found. Cannot assign carrier.", Severity.Error);
            return;
        }
        var delivery = await db.Deliveries.FirstOrDefaultAsync(d => d.OrderId == selectedOrderId);
        if (delivery == null)
        {
            delivery = new Delivery { OrderId = selectedOrderId };
            db.Deliveries.Add(delivery);
        }
        delivery.CarrierId = selectedCarrierId;
        delivery.TrackingNumber = tracking ?? string.Empty;
        delivery.Status = DeliveryStatus.InTransit;
        // when marked delivered in UI elsewhere, update to Delivered
        await db.SaveChangesAsync();
        Snackbar.Add("Carrier assigned", Severity.Success);
        // notify Orders page via navigation and refresh
        Nav.NavigateTo("/admin/orders");
    }

    private void Cancel()
    {
        Nav.NavigateTo("/admin/orders");
    }
}
