@page "/admin/notifications"
@using Microsoft.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore.Infrastructure
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@inject IDbContextFactory<VeronaShop.Data.ApplicationDbContext> DbFactory
@using MudBlazor
@using System.Linq
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<h3>Notification delivery status</h3>

@if (notifications == null)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (!notifications.Any())
{
    <MudPaper Class="pa-4">No notifications yet.</MudPaper>
}
else
{
    <MudTable Items="notifications" Dense="true" Hover="true">
        <HeaderContent>
            <MudTh>Id</MudTh>
            <MudTh>Order</MudTh>
            <MudTh>Recipient</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Attempted</MudTh>
            <MudTh>Error</MudTh>
            <MudTh>Created</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Id</MudTd>
            <MudTd>@context.OrderNumber</MudTd>
            <MudTd>@context.RecipientEmail</MudTd>
            <MudTd>@context.Status</MudTd>
            <MudTd>@context.AttemptedAt</MudTd>
            <MudTd>@context.ErrorMessage</MudTd>
            <MudTd>@context.CreatedAt</MudTd>
            <MudTd>
                <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="@(async () => await MarkOrderPaid(context.Id))">Mark order paid</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private List<Notification> notifications;
    [Inject] private Microsoft.AspNetCore.SignalR.IHubContext<VeronaShop.Services.NotificationHub> HubContext { get; set; }
    [Inject] private IDbContextFactory<VeronaShop.Data.ApplicationDbContext> DbFactory2 { get; set; }
    [Inject] private Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager { get; set; }
    [CascadingParameter] private System.Threading.Tasks.Task<Microsoft.AspNetCore.Components.Authorization.AuthenticationState> AuthenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();
        notifications = await db.Notifications.OrderByDescending(n => n.CreatedAt).Take(200).ToListAsync();

        // mark views for the current admin
        try
        {
            var auth = await AuthenticationStateTask;
            var user = auth.User;
            if (user?.Identity?.IsAuthenticated == true)
            {
                var appUser = await UserManager.GetUserAsync(user);
                if (appUser != null)
                {
                    var adminId = appUser.Id;
                    using var db2 = DbFactory2.CreateDbContext();
                    var existingViews = new List<int>();
                    if (await db2.TableExistsAsync("NotificationViews"))
                        existingViews = await db2.NotificationViews.Where(nv => nv.AdminId == adminId).Select(nv => nv.NotificationId).ToListAsync();
                    var toView = await db2.Notifications.Where(n => !existingViews.Contains(n.Id)).ToListAsync();
                    if (toView.Any())
                    {
                        foreach (var n in toView)
                        {
                            db2.NotificationViews.Add(new VeronaShop.Data.Entites.NotificationView { NotificationId = n.Id, AdminId = adminId, ViewedAt = DateTimeOffset.UtcNow });
                        }
                        await db2.SaveChangesAsync();
                        // broadcast remaining unviewed count per admin is not global; notify clients of global pending orders and total unviewed across all admins for simplicity
                        var totalViews = 0;
                        if (await db2.TableExistsAsync("NotificationViews"))
                            totalViews = await db2.NotificationViews.CountAsync();
                        await HubContext.Clients.All.SendCoreAsync("NotifyCounts", new object[] { await db2.Orders.Where(o => o.Status == VeronaShop.Data.Entites.OrderStatus.Pending).CountAsync(), totalViews });
                    }
                }
            }
        }
        catch { }
    }

    private async Task MarkOrderPaid(int orderId)
    {
        try
        {
            using var db = DbFactory.CreateDbContext();
            var o = await db.Orders.FindAsync(orderId);
            if (o != null)
            {
                o.IsPaid = true;
                o.PaidAt = DateTimeOffset.UtcNow;
                await db.SaveChangesAsync();
            }
        }
        catch { }
    }
}
