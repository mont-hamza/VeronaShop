@page "/admin/carriers"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<MudPaper Class="pa-4">
    <div class="d-flex justify-space-between align-center">
        <h3>Manage Carriers</h3>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateNew">Add carrier</MudButton>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <MudAlert Severity="Severity.Success" Elevation="0">@message</MudAlert>
    }

    @if (editing != null)
    {
        <MudPaper Class="pa-3 mt-3">
            <EditForm Model="editing" OnValidSubmit="Save">
                <DataAnnotationsValidator />
                <MudTextField @bind-Value="editing.Name" Label="Name" Required="true" />
                <MudTextField @bind-Value="editing.Phone" Label="Phone" />
                <MudCheckBox T="bool" @bind-Checked="editing.IsActive">Active</MudCheckBox>
                <div class="mt-2">
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Save</MudButton>
                    <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
                </div>
            </EditForm>
        </MudPaper>
    }

    <MudExpansionPanels Class="mt-3">
        @foreach (var c in carriers)
        {
            <MudExpansionPanel Text="@c.Name" Icon="@Icons.Material.Filled.LocalShipping">
                <div class="d-flex align-center" style="gap:8px">
                    <MudChip T="string" Color="@(IsCarrierWorkingNow(c) ? Color.Success : Color.Default)" Variant="Variant.Filled">@(IsCarrierWorkingNow(c) ? "Active now" : "Off hours")</MudChip>
                    <MudText Typo="Typo.caption">Phone: @c.Phone</MudText>
                    <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="@(() => Edit(c))">Edit</MudButton>
                    <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Error" OnClick="@(() => PromptDelete(c))">Delete</MudButton>
                </div>
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.subtitle2">Assigned Orders</MudText>
                @if (assigned.TryGetValue(c.Id, out var items) && items.Any())
                {
                    <MudTable Items="items" Dense="true">
                        <HeaderContent>
                            <MudTh>Order</MudTh>
                            <MudTh>Date</MudTh>
                            <MudTh>Customer</MudTh>
                            <MudTh>Tracking</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.OrderNumber</MudTd>
                            <MudTd>@context.OrderDate.ToString("g")</MudTd>
                            <MudTd>@context.CustomerName</MudTd>
                            <MudTd>@context.Tracking</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudText Typo="Typo.caption">No assigned orders.</MudText>
                }
            </MudExpansionPanel>
        }
    </MudExpansionPanels>
</MudPaper>

@code {
    private List<Carrier> carriers = new();
    private Carrier editing = null;
    private Carrier toDelete = null;
    private string message;
    private Dictionary<int, List<(string OrderNumber, DateTimeOffset OrderDate, string CustomerName, string Tracking)>> assigned = new();

    [Inject] private IDbContextFactory<ApplicationDbContext> DbFactory { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        using var db = DbFactory.CreateDbContext();
        carriers = await db.Carriers.OrderBy(c => c.Name).ToListAsync();
        // load assigned orders per carrier
        var items = await db.Deliveries.Include(d=>d.Order).ThenInclude(o=>o.Customer).Include(d=>d.Carrier)
            .Where(d=>d.CarrierId != null).OrderByDescending(d=>d.Order.OrderDate).ToListAsync();
        assigned = items
            .GroupBy(d=>d.CarrierId!.Value)
            .ToDictionary(g=>g.Key, g=>g.Select(d=> (d.Order.OrderNumber, d.Order.OrderDate, d.Order.Customer?.Name ?? string.Empty, d.TrackingNumber)).ToList());
    }

    private void CreateNew()
    {
        editing = new Carrier { Name = string.Empty, Phone = string.Empty, IsActive = true, DailyStart = new TimeSpan(9,0,0), DailyEnd = new TimeSpan(17,0,0) };
    }

    private bool IsCarrierWorkingNow(Carrier c)
    {
        if (c.DailyStart == null || c.DailyEnd == null) return c.IsActive;
        var now = DateTime.Now.TimeOfDay;
        return c.IsActive && now >= c.DailyStart && now <= c.DailyEnd;
    }

    private void Edit(Carrier c)
    {
        editing = new Carrier { Id = c.Id, Name = c.Name, Phone = c.Phone, IsActive = c.IsActive };
    }

    private void Cancel()
    {
        editing = null;
    }

    private async Task Save()
    {
        using var db = DbFactory.CreateDbContext();
        if (editing.Id == 0)
        {
            db.Carriers.Add(editing);
        }
        else
        {
            var existing = await db.Carriers.FindAsync(editing.Id);
            if (existing != null)
            {
                existing.Name = editing.Name;
                existing.Phone = editing.Phone;
                existing.IsActive = editing.IsActive;
            }
        }
        await db.SaveChangesAsync();
        editing = null;
        message = "Carrier saved.";
        await LoadAsync();
    }

    private void PromptDelete(Carrier c)
    {
        toDelete = c;
    }

    private async Task ConfirmDelete()
    {
        if (toDelete != null)
        {
            using var db = DbFactory.CreateDbContext();
            var existing = await db.Carriers.FindAsync(toDelete.Id);
            if (existing != null)
            {
                db.Carriers.Remove(existing);
                await db.SaveChangesAsync();
                message = "Carrier deleted.";
            }
            toDelete = null;
            await LoadAsync();
        }
    }
}
