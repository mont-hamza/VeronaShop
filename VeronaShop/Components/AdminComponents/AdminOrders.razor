@page "/admin/orders"
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.SignalR
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject Microsoft.AspNetCore.SignalR.IHubContext<VeronaShop.Services.NotificationHub> HubContext
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<h3>@L["ManageOrders"]</h3>

<MudPaper Class="pa-4">
    @* Status legend removed to reduce clutter *@
    <div class="d-flex gap-3 align-center mb-3 wrap-on-mobile" style="flex-wrap:wrap">
        <MudTextField @bind-Value="searchTerm" Placeholder="@L["SearchOrdersPlaceholder"]" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Immediate="true" OnImmediateValueChanged="OnSearchChanged" />

            <MudSelect T="VeronaShop.Data.Entites.OrderStatus?" Value="statusFilter" Placeholder="@L["AllStatuses"]" Dense="true" Style="min-width:200px" ValueChanged="@(async (VeronaShop.Data.Entites.OrderStatus? v) => { statusFilter = v; page = 0; await LoadOrdersAsync(); })">
            <MudSelectItem T="VeronaShop.Data.Entites.OrderStatus?" Value="null">@L["AllStatuses"]</MudSelectItem>
            @foreach (var s in Enum.GetValues(typeof(VeronaShop.Data.Entites.OrderStatus)).Cast<VeronaShop.Data.Entites.OrderStatus>())
            {
                <MudSelectItem T="VeronaShop.Data.Entites.OrderStatus?" Value="@s">@s</MudSelectItem>
            }
        </MudSelect>

        <MudSelect T="bool?" Value="isPaidFilter" Placeholder="@L["Payment"]" Dense="true" Style="min-width:160px" ValueChanged="@(async (bool? v) => { isPaidFilter = v; page = 0; await LoadOrdersAsync(); })">
            <MudSelectItem T="bool?" Value="null">@L["AllPayments"]</MudSelectItem>
            <MudSelectItem T="bool?" Value="true">@L["Paid"]</MudSelectItem>
            <MudSelectItem T="bool?" Value="false">@L["Unpaid"]</MudSelectItem>
        </MudSelect>

        <MudDatePicker @bind-Date="dateFrom" Label="From" Clearable="true" />
        <MudDatePicker @bind-Date="dateTo" Label="To" Clearable="true" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="@(async (MouseEventArgs e) => await ApplyFilters(e))">Apply</MudButton>

        <MudSpacer />

        <div class="d-flex align-center">
            <MudText Typo="Typo.body2" Class="mr-2">Page size</MudText>
            <MudSelect T="int" Value="pageSize" Dense="true" ValueChanged="@(async (int v) => { pageSize = v; page = 0; await LoadOrdersAsync(); })" Style="width:80px">
                <MudSelectItem T="int" Value="10">10</MudSelectItem>
                <MudSelectItem T="int" Value="20">20</MudSelectItem>
                <MudSelectItem T="int" Value="50">50</MudSelectItem>
            </MudSelect>
        </div>
    </div>

    @if (orders == null)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (!orders.Any())
    {
        <MudText>No orders found.</MudText>
    }
    else
    {
        <MudGrid GutterSize="GutterSize.Small">
            @foreach (var o in orders)
            {
                <MudItem xs="12" sm="6" md="4">
                    @{ var cls = "order-card-elevated" + (recentlyChangedIds.Contains(o.Id) ? " order-status-flash" : string.Empty); }
                    <MudCard Class="@cls">
                        <MudCardContent>
                            <div class="d-flex justify-space-between align-center">
                                <div>
                                    <MudText Typo="Typo.h6">@o.OrderNumber</MudText>
                                    <MudText Typo="Typo.caption">@o.OrderDate.ToString("g")</MudText>
                                </div>
                            <div class="d-flex admin-order-actions" style="gap:8px;align-items:center;">
                                        <MudChip T="string" Color="@(GetStatusColor(o.Status))" Variant="Variant.Filled">@o.Status</MudChip>
                                    <MudButton Size="Size.Small" Variant="@(o.IsPaid ? Variant.Filled : Variant.Outlined)" Color="@(o.IsPaid ? Color.Success : Color.Primary)" OnClick="@(async () => await TogglePaidAsync(o.Id))" Disabled="@(savingPaidIds.Contains(o.Id))">
                                        @if (savingPaidIds.Contains(o.Id))
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                        }
                                        @((o.IsPaid) ? L["Paid"] : L["MarkPaid"])
                                    </MudButton>
                                </div>
                            </div>

                            <MudDivider Class="my-2" />

                            <div>
                                <MudText>@o.Customer?.Name</MudText>
                                <MudText Typo="Typo.caption">@o.Customer?.Email</MudText>
                                @if (TryGetDelivery(o.Id, out var del))
                                {
                                    <MudText Typo="Typo.caption">Carrier: @del.CarrierName — @del.Tracking</MudText>
                                }
                            </div>

                            <div class="d-flex justify-space-between align-center mt-2">
                                <div>
                                    <MudText Typo="Typo.subtitle1">@o.TotalAmount</MudText>
                                </div>
                                <div class="d-flex order-action-compact" style="gap:8px;align-items:center;">
                                    <MudMenu Icon="@Icons.Material.Filled.Edit" Size="Size.Medium" Color="Color.Primary" Variant="Variant.Filled">
                                        <MudMenuItem OnClick="@(async () => await ShowDetailsDialog(o.Id))">@L["Details"]</MudMenuItem>
                                        <MudDivider />
                                        @foreach (var sOpt in Enum.GetValues(typeof(OrderStatus)).Cast<OrderStatus>())
                                        {
                                            <MudMenuItem OnClick="@( async () => await QuickChangeStatus(o.Id, sOpt) )">@sOpt</MudMenuItem>
                                        }
                                        @if (o.Status == OrderStatus.Shipped)
                                        {
                                            <MudDivider />
                                            <MudMenuItem Href="@($"/admin/deliveries?orderId={o.Id}")">@L["AssignCarrier"]</MudMenuItem>
                                            @if (quickAssignCarriers != null && quickAssignCarriers.Any())
                                            {
                                                <MudMenu Dense="true" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                                                    <ActivatorContent>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Bolt">@L["QuickAssign"]</MudButton>
                                                    </ActivatorContent>
                                                    <ChildContent>
                                                        @foreach (var c in quickAssignCarriers)
                                                        {
                                                            <MudMenuItem OnClick="@(async ()=> await QuickAssignCarrierAsyncInternal(o.Id, c.Id, c.Name))">@c.Name (@c.Phone)</MudMenuItem>
                                                        }
                                                    </ChildContent>
                                                </MudMenu>
                                            }
                                            
                                            }
                                    </MudMenu>
                                </div>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <div class="d-flex justify-space-between align-center mt-3">
            <div>
                <MudText Typo="Typo.caption">Showing page @(page+1) of @TotalPages — @totalCount orders</MudText>
            </div>
            <div class="d-flex gap-2">
                <MudButton Disabled="@(page==0)" OnClick="@(async () => await FirstPage())">First</MudButton>
                <MudButton Disabled="@(page==0)" OnClick="@(async () => await PrevPage())">Previous</MudButton>
                <MudButton Disabled="@(page>=TotalPages-1)" OnClick="@(async () => await NextPage())">Next</MudButton>
                <MudButton Disabled="@(page>=TotalPages-1)" OnClick="@(async () => await LastPage())">Last</MudButton>
            </div>
        </div>
    }

    @if (selectedOrder != null)
    {
        <MudDivider Class="my-4" />
        <MudPaper Class="pa-3">
            <MudText Typo="Typo.h6">@L["Order"] @selectedOrder.OrderNumber</MudText>
            <MudText>@L["Placed"]: @selectedOrder.OrderDate.ToString("g")</MudText>
            <MudText>@L["Customer"]: @selectedOrder.Customer?.Name (@selectedOrder.Customer?.Email)</MudText>
            @* Inline carrier assignment removed to fix build; use Assign Carrier page via menu *@
            <MudTable Items="selectedOrder.OrderProducts" Dense="true">
                <HeaderContent>
                    <MudTh>@L["Product"]</MudTh>
                    <MudTh>@L["Qty"]</MudTh>
                    <MudTh>@L["Unit"]</MudTh>
                    <MudTh>@L["Line"]</MudTh>
                    <MudTh>@L["Size"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.ProductName</MudTd>
                    <MudTd>@context.Quantity</MudTd>
                    <MudTd>@context.UnitPrice.ToString("C")</MudTd>
                    <MudTd>@(context.UnitPrice * context.Quantity).ToString("C")</MudTd>
                    <MudTd>@context.SizeName</MudTd>
                </RowTemplate>
            </MudTable>
            <div class="d-flex justify-space-between mt-2">
                <div />
                <div>
                    <MudText Typo="Typo.h6">@L["Total"]: @selectedOrder.TotalAmount.ToString("C")</MudText>
                </div>
            </div>
            <div class="mt-2">
                <MudButton Variant="Variant.Outlined" OnClick="CloseDetails">@L["Close"]</MudButton>
            </div>
        </MudPaper>
    }

</MudPaper>

@code {
    private List<Orders>? orders;
    private Orders? selectedOrder;

    // search / filter / paging
    private string? searchTerm;
    private OrderStatus? statusFilter;
    private bool? isPaidFilter;
    private DateTime? dateFrom;
    private DateTime? dateTo;
    private int page = 0;
    private int pageSize = 10;
    private int totalCount = 0;

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(totalCount / (double)pageSize));

    // recent highlight tracking
    private HashSet<int> recentlyChangedIds = new();
    private HashSet<int> savingPaidIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrdersAsync();
        try
        {
            using var db = DbFactory.CreateDbContext();
            quickAssignCarriers = await db.Carriers.Where(c=>c.IsActive)
                .OrderBy(c=>c.Name)
                .Select(c=> new CarrierInfo { Id = c.Id, Name = c.Name, Phone = c.Phone ?? string.Empty })
                .ToListAsync();
        }
        catch { }
    }

    private async Task OnSearchChanged(string value)
    {
        searchTerm = value;
        page = 0;
        await LoadOrdersAsync();
    }

    private async Task LoadOrdersAsync()
    {
        using var db = DbFactory.CreateDbContext();
        var q = db.Set<VeronaShop.Data.Entites.Orders>().AsQueryable();
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var s = searchTerm.Trim();
            q = q.Where(o => o.OrderNumber.Contains(s) || o.Customer.Email.Contains(s) || o.Customer.Name.Contains(s));
        }
        if (statusFilter.HasValue)
            q = q.Where(o => o.Status == statusFilter.Value);
        if (isPaidFilter.HasValue)
            q = q.Where(o => o.IsPaid == isPaidFilter.Value);
        if (dateFrom.HasValue)
            q = q.Where(o => o.OrderDate >= dateFrom.Value);
        if (dateTo.HasValue)
            q = q.Where(o => o.OrderDate <= dateTo.Value.AddDays(1));

        totalCount = await q.CountAsync();

        orders = await q
            .Include(o => o.Customer)
            .Include(o => o.OrderProducts)
            .OrderByDescending(o => o.CreatedAt)
            .Skip(page * pageSize)
            .Take(pageSize)
            .ToListAsync();
    }

    // lightweight cache of deliveries to render per card without joins
    private Dictionary<int,(string CarrierName,string Tracking)> deliveries = new();
    private bool TryGetDelivery(int orderId, out (string CarrierName,string Tracking) d)
    {
        if (deliveries.TryGetValue(orderId, out d)) return true;
        try
        {
            using var db = DbFactory.CreateDbContext();
            var del = db.Deliveries.Include(x=>x.Carrier).AsNoTracking().FirstOrDefault(x=>x.OrderId==orderId);
            if (del != null)
            {
                var val = (del.Carrier?.Name ?? "", del.TrackingNumber ?? "");
                deliveries[orderId] = val;
                d = val;
                return true;
            }
        }
        catch { }
        d = default;
        return false;
    }

    private async Task TogglePaidAsync(int orderId)
    {
        // optimistic UI: flip local state immediately, then persist
        try
        {
            var mem = orders?.FirstOrDefault(x => x.Id == orderId);
            if (mem == null) { Snackbar.Add("Order not found", Severity.Warning); return; }

            // flip locally
            mem.IsPaid = !mem.IsPaid;
            if (mem.IsPaid)
                mem.PaidAt = DateTimeOffset.UtcNow;
            else
                mem.PaidAt = null;

            savingPaidIds.Add(orderId);
            await InvokeAsync(StateHasChanged);

            using var db = DbFactory.CreateDbContext();
            var o = await db.Orders.FindAsync(orderId);
            if (o == null)
            {
                Snackbar.Add("Order not found in database", Severity.Error);
                // revert
                mem.IsPaid = !mem.IsPaid;
                savingPaidIds.Remove(orderId);
                await InvokeAsync(StateHasChanged);
                return;
            }

            o.IsPaid = mem.IsPaid;
            o.PaidAt = mem.PaidAt;
            o.UpdatedAt = DateTimeOffset.UtcNow;
            await db.SaveChangesAsync();

            // broadcast update to all admin clients
            try
            {
                var pendingCount = await db.Orders.Where(x => x.Status == OrderStatus.Pending).CountAsync();
                var totalNotifications = await db.Notifications.CountAsync();
                await HubContext.Clients.All.SendCoreAsync("NotifyCounts", new object[] { pendingCount, totalNotifications });
                await HubContext.Clients.All.SendCoreAsync("NewNotification", new object[] { o.OrderNumber, DateTimeOffset.UtcNow.ToString("o") });
            }
            catch { }

            Snackbar.Add($"Order {o.OrderNumber} payment updated", Severity.Success);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            // revert optimistic change on failure
            var mem = orders?.FirstOrDefault(x => x.Id == orderId);
            if (mem != null) mem.IsPaid = !mem.IsPaid;
            Snackbar.Add("Failed to update payment status", Severity.Error);
        }
        finally
        {
            savingPaidIds.Remove(orderId);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ShowDetails(int orderId)
    {
        using var db = DbFactory.CreateDbContext();
        selectedOrder = await db.Set<VeronaShop.Data.Entites.Orders>()
            .Include(o => o.Customer)
            .Include(o => o.OrderProducts)
            .FirstOrDefaultAsync(o => o.Id == orderId);
        if (selectedOrder == null)
        {
            Snackbar.Add("Order not found", Severity.Warning);
        }
    }

    private async Task ShowDetailsDialog(int orderId)
    {
        using var db = DbFactory.CreateDbContext();
        var order = await db.Set<VeronaShop.Data.Entites.Orders>()
            .Include(o => o.Customer)
            .Include(o => o.OrderProducts)
            .FirstOrDefaultAsync(o => o.Id == orderId);

        var parameters = new MudBlazor.DialogParameters { ["Order"] = order };
        var options = new MudBlazor.DialogOptions { MaxWidth = MudBlazor.MaxWidth.Large, FullWidth = true };
        var dialog = DialogService.Show<VeronaShop.Components.AdminComponents.OrderDetailsDialog>("Order details", parameters, options);
        await dialog.Result;
    }

    private void CloseDetails()
    {
        selectedOrder = null;
    }

    private async Task ChangeStatus(int orderId, OrderStatus status)
    {
        try
        {
            using var db = DbFactory.CreateDbContext();
            var o = await db.Orders.FindAsync(orderId);
            if (o != null)
            {
                o.Status = status;
                o.UpdatedAt = DateTimeOffset.UtcNow;
                await db.SaveChangesAsync();
                Snackbar.Add($"Order {o.OrderNumber} status updated", Severity.Success);
                await LoadOrdersAsync();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            Snackbar.Add("Failed to update status", Severity.Error);
        }
    }

    private async Task MarkOrderPaidFromCard(int orderId)
    {
        try
        {
            using var db = DbFactory.CreateDbContext();
            var o = await db.Orders.FindAsync(orderId);
            if (o != null && !o.IsPaid)
            {
                o.IsPaid = true;
                o.PaidAt = DateTimeOffset.UtcNow;
                await db.SaveChangesAsync();
                Snackbar.Add($"Marked {o.OrderNumber} as paid", Severity.Success);
                await LoadOrdersAsync();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            Snackbar.Add("Failed to mark order paid", Severity.Error);
        }
    }

    private async Task ApplyFilters(MouseEventArgs e)
    {
        page = 0;
        await LoadOrdersAsync();
    }

    private async Task FirstPage()
    {
        page = 0;
        await LoadOrdersAsync();
    }

    private async Task PrevPage()
    {
        page = Math.Max(0, page - 1);
        await LoadOrdersAsync();
    }

    private async Task NextPage()
    {
        page = Math.Min(TotalPages - 1, page + 1);
        await LoadOrdersAsync();
    }

    private async Task LastPage()
    {
        page = TotalPages - 1;
        await LoadOrdersAsync();
    }

    // Quick assign support
    private class CarrierInfo { public int Id { get; set; } public string Name { get; set; } = string.Empty; public string Phone { get; set; } = string.Empty; }
    private List<CarrierInfo> quickAssignCarriers = new();
    private async Task QuickAssignCarrierAsyncInternal(int orderId, int carrierId, string carrierName)
    {
        try
        {
            using var db = DbFactory.CreateDbContext();
            var order = await db.Orders.FirstOrDefaultAsync(o=>o.Id==orderId);
            if (order == null) { Snackbar.Add("Order not found", Severity.Error); return; }
            var delivery = await db.Deliveries.FirstOrDefaultAsync(d=>d.OrderId==orderId);
            if (delivery == null)
            {
                delivery = new Delivery { OrderId = orderId };
                db.Deliveries.Add(delivery);
            }
            delivery.CarrierId = carrierId;
            delivery.Status = DeliveryStatus.InTransit;
            await db.SaveChangesAsync();
            deliveries[orderId] = (carrierName, deliveries.TryGetValue(orderId, out var d) ? d.Tracking : string.Empty);
            Snackbar.Add($"Assigned to {carrierName}", Severity.Success);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            Snackbar.Add("Failed to assign carrier", Severity.Error);
        }
    }

    private Color GetStatusColor(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => Color.Warning,
            OrderStatus.Processing => Color.Info,
            OrderStatus.Shipped => Color.Primary,
            OrderStatus.Delivered => Color.Success,
            OrderStatus.Cancelled => Color.Error,
            _ => Color.Default,
        };
    }

    

    private async Task QuickChangeStatus(int orderId, OrderStatus status)
    {
        try
        {
            using var db = DbFactory.CreateDbContext();
            var o = await db.Orders.FindAsync(orderId);
            if (o == null) { Snackbar.Add("Order not found", Severity.Warning); return; }
            o.Status = status;
            o.UpdatedAt = DateTimeOffset.UtcNow;
            await db.SaveChangesAsync();
            // create a notification for customer about status change
            try
            {
                var customer = await db.Customers.FindAsync(o.CustomerId);
                if (customer != null)
                {
                    db.Notifications.Add(new VeronaShop.Data.Entites.Notification
                    {
                        OrderNumber = o.OrderNumber,
                        RecipientEmail = customer.Email ?? string.Empty,
                        Status = VeronaShop.Data.Entites.NotificationStatus.Pending,
                        CreatedAt = DateTimeOffset.UtcNow
                    });
                    await db.SaveChangesAsync();
                }
            }
            catch { }
            // update UI immediately
            var mem = orders?.FirstOrDefault(x => x.Id == orderId);
            if (mem != null)
            {
                mem.Status = status;
                mem.UpdatedAt = o.UpdatedAt;
            }
            if (selectedOrder != null && selectedOrder.Id == orderId)
            {
                selectedOrder.Status = status;
                selectedOrder.UpdatedAt = o.UpdatedAt;
            }
            recentlyChangedIds.Add(orderId);
            Snackbar.Add($"Order {o.OrderNumber} status updated to {status}", Severity.Success);
            _ = Task.Run(async () => { await Task.Delay(1400); recentlyChangedIds.Remove(orderId); await InvokeAsync(StateHasChanged); });
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            Snackbar.Add("Failed to update status", Severity.Error);
        }
    }
}
