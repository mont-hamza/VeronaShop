@page "/admin/users"
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using VeronaShop.Data
@using VeronaShop.Data.Entites
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole<int>> RoleManager
@inject ISnackbar Snackbar
@inject ILogger<Users> Logger
@inject IDbContextFactory<VeronaShop.Data.ApplicationDbContext> DbFactory
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<MudPaper Class="pa-4">
    <div class="d-flex justify-space-between align-center">
        <MudText Typo="Typo.h5">Users</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadUsers">Refresh</MudButton>
    </div>

    <MudTable Items="users" Dense="true" Hover="true" Class="mt-3">
        <HeaderContent>
            <MudTh>Id</MudTh>
            <MudTh>User</MudTh>
            <MudTh>Email</MudTh>
            <MudTh>Roles</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Id">@context.Id</MudTd>
            <MudTd DataLabel="User">@context.UserName</MudTd>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            <MudTd DataLabel="Roles">@context.Roles</MudTd>
            <MudTd>
                <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="@( () => EditRoles(context.Id) )">Roles</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>

    @if (editingUser != null)
    {
        <MudPaper Class="pa-3 mt-3">
            <MudText Typo="Typo.h6">Edit Roles for @editingUser.UserName</MudText>
            <div>
                @foreach (var role in roleList)
                {
                    <div class="d-flex align-center mb-2">
                        <MudCheckBox T="bool" @bind-Checked="role.Selected" />
                        <div class="ml-2">@role.Name</div>
                    </div>
                }
            </div>
            <div class="mt-2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveRoles">Save</MudButton>
                <MudButton Variant="Variant.Text" OnClick="CancelEdit">Cancel</MudButton>
            </div>
        </MudPaper>
    }
</MudPaper>

@code {
    private class SimpleUser { public int Id; public string UserName; public string Email; public string Roles; }
    private List<SimpleUser> users = new();
    private ApplicationUser editingUser;
    private class RoleEntry { public string Name { get; set; } public bool Selected { get; set; } }
    private List<RoleEntry> roleList = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        users.Clear();
        var list = await UserManager.Users.ToListAsync();
        foreach (var u in list)
        {
            var roles = await UserManager.GetRolesAsync(u);
            users.Add(new SimpleUser { Id = u.Id, UserName = u.UserName, Email = u.Email, Roles = string.Join(", ", roles) });
        }
    }

    private async Task EditRoles(int userId)
    {
        editingUser = await UserManager.FindByIdAsync(userId.ToString());
        var roles = await RoleManager.Roles.Select(r => r.Name).ToListAsync();
        roleList = new List<RoleEntry>();
        foreach (var r in roles)
        {
            var inRole = await UserManager.IsInRoleAsync(editingUser, r);
            roleList.Add(new RoleEntry { Name = r, Selected = inRole });
        }
        StateHasChanged();
    }

    private async Task SaveRoles()
    {
        if (editingUser == null) return;

        try
        {
            var selectedRoles = roleList.Where(x => x.Selected).Select(x => x.Name).ToArray();

            // get current roles for this user via Identity API
            var currentRoles = await UserManager.GetRolesAsync(editingUser);

            var toRemove = currentRoles.Except(selectedRoles, StringComparer.OrdinalIgnoreCase).ToArray();
            var toAdd = selectedRoles.Except(currentRoles, StringComparer.OrdinalIgnoreCase).ToArray();

            if (toRemove.Any())
            {
                var res = await UserManager.RemoveFromRolesAsync(editingUser, toRemove);
                if (!res.Succeeded)
                {
                    var err = string.Join("; ", res.Errors.Select(e => e.Description));
                    Snackbar.Add($"Failed to remove roles: {err}", Severity.Error);
                    return;
                }
            }

            if (toAdd.Any())
            {
                var res = await UserManager.AddToRolesAsync(editingUser, toAdd);
                if (!res.Succeeded)
                {
                    var err = string.Join("; ", res.Errors.Select(e => e.Description));
                    Snackbar.Add($"Failed to add roles: {err}", Severity.Error);
                    return;
                }
            }

            // optional: invalidate security stamp so next sign-in refreshes role claims
            try { await UserManager.UpdateSecurityStampAsync(editingUser); } catch { }

            // log current roles
            try
            {
                var refreshed = await UserManager.FindByIdAsync(editingUser.Id.ToString());
                var rolesNow = await UserManager.GetRolesAsync(refreshed);
                Logger.LogInformation("Roles for {User} after update: {Roles}", editingUser.UserName, string.Join(',', rolesNow));
            }
            catch { }

            Snackbar.Add("Roles updated", Severity.Success);
            editingUser = null;
            await LoadUsers();
        }
        catch (Exception ex)
        {
            try { Logger.LogError(ex, "SaveRoles failed"); } catch { }
            Snackbar.Add("Failed to save roles: " + ex.Message, Severity.Error);
        }
    }

    private void CancelEdit()
    {
        editingUser = null;
    }
}
