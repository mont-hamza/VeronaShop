@page "/"

@using Microsoft.EntityFrameworkCore
@using System.Linq
@using Microsoft.EntityFrameworkCore.Infrastructure
@using VeronaShop.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider
@using VeronaShop.Data.Entites
@using MudBlazor
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L

<PageTitle>@L["HomeTitle"]</PageTitle>

<MudContainer Class="mt-6">
    <div class="d-flex justify-end mb-2">
        <AuthorizeView>
            <Authorized>
                <a href="/account/profile" class="mud-button-root mud-button mud-button-filled" style="text-decoration:none;padding:6px 10px;border-radius:6px">@L["Profile"]</a>
            </Authorized>
        </AuthorizeView>
    </div>
    <!-- Featured horizontal scroller (carousel-like) -->
    <MudPaper Class="pa-3 mb-6" Style="overflow-x:auto;white-space:nowrap;">
        @foreach (var c in carouselProducts)
        {
            <div style="display:inline-block; width:320px; margin-right:12px; vertical-align:top;">
                <div style="height:240px; background:#f5f5f5; display:flex; align-items:center; justify-content:center;">
                    <img src="@(string.IsNullOrEmpty(c.ImageUrl) ? "images/placeholder.svg" : c.ImageUrl)" alt="@c.Name" style="max-height:220px;max-width:100%;object-fit:contain" />
                </div>
                <div class="pa-2">
                    <MudText Typo="Typo.h6">@c.Name</MudText>
                    <MudText Typo="Typo.subtitle2">@($"LYD {c.Price:N2}")</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NavigateToShop">@L["ShopNow"]</MudButton>
                </div>
            </div>
        }
    </MudPaper>

    <!-- Promotions -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6">@L["Promotions"]</MudText>
        <div class="d-flex gap-3 mt-3">
            @foreach (var promo in promotions)
            {
                <MudCard Style="flex:1;min-height:120px;">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@promo.Title</MudText>
                        <MudText Typo="Typo.body2">@promo.Description</MudText>
                    </MudCardContent>
                </MudCard>
            }
        </div>
    </MudPaper>

    <!-- Posts / Announcements -->
    <MudPaper Class="pa-4 mb-4">
        <div class="d-flex justify-space-between align-center">
            <MudText Typo="Typo.h6">@L["LatestPosts"]</MudText>
            <AuthorizeView Roles="Admin">
                <Authorized>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick='@(() => Navigation.NavigateTo("/admin/posts"))'>@L["ManagePosts"]</MudButton>
                </Authorized>
            </AuthorizeView>
        </div>
        <div class="mt-3">
            @if (!posts.Any())
            {
                <MudText Typo="Typo.body2">@L["NoPostsYet"]</MudText>
            }
            else
            {
                foreach (var post in posts)
                {
                    <MudCard Class="mb-2">
                        <MudCardContent>
                            <MudText Typo="Typo.h6">@post.Title</MudText>
                            <MudText Typo="Typo.body2">@post.Summary</MudText>
                        </MudCardContent>
                    </MudCard>
                }
            }
        </div>
    </MudPaper>
</MudContainer>

@code {
    private List<VeronaShop.Data.Entites.Product> carouselProducts = new();
    private List<(string Title, string Description)> promotions = new();
    private List<(string Title, string Summary)> posts = new();

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();
        // include images so UI can use the canonical ProductImages table
        carouselProducts = await db.Products.Include(p => p.Images).OrderByDescending(p => p.CreatedAt).Take(5).ToListAsync();
        promotions = new List<(string, string)>
        {
            (L["PromoWinterSale"], L["PromoWinterDescription"]),
            (L["PromoFreeShipping"], L["PromoShippingDescription"]),
        };
        posts = new List<(string, string)>();
    }

    private void NavigateToShop()
    {
        Navigation.NavigateTo("/shop");
    }
}
