@page "/account/login"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using VeronaShop.Data.Entites
@using Microsoft.AspNetCore.WebUtilities
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject VeronaShop.Services.CartService CartService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<h3>Login</h3>

<EditForm Model="loginModel" OnValidSubmit="HandleLogin" FormName="LoginForm">
    <DataAnnotationsValidator />
    <ValidationSummary />
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="text-danger">@errorMessage</p>
    }

    

    <div>
        <label>Username or Email</label>
        <InputText @bind-Value="loginModel.UserNameOrEmail" />
    </div>
    <div>
        <label>Password</label>
        <InputText @bind-Value="loginModel.Password" type="password" />
    </div>

    <button type="submit">Login</button>
</EditForm>

<!-- Fallback: non-Blazor POST for cookie-based auth when Blazor sign-in fails due to headers started -->
<form method="post" action="/auth/login" style="display:none" id="fallbackLoginForm">
    <input name="user" id="fallback-user" />
    <input name="password" id="fallback-password" />
    <input name="returnUrl" id="fallback-returnUrl" />
    <input name="sessionId" id="fallback-sessionId" />
</form>

@code {
    private LoginModel loginModel = new LoginModel();
    private string errorMessage;
    private string returnUrl;

    public class LoginModel
    {
        [Required]
        public string UserNameOrEmail { get; set; }
        [Required]
        public string Password { get; set; }
    }

    protected override void OnInitialized()
    {
        // read returnUrl from query string if present
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("returnUrl", out var ru))
        {
            returnUrl = ru.FirstOrDefault();
        }
    }

    private async Task HandleLogin()
    {
        errorMessage = null;
        // allow login by username or email
        ApplicationUser user = null;
        if (loginModel.UserNameOrEmail.Contains("@"))
        {
            user = await UserManager.FindByEmailAsync(loginModel.UserNameOrEmail);
        }
        else
        {
            user = await UserManager.FindByNameAsync(loginModel.UserNameOrEmail);
        }

        if (user != null)
        {
            try
            {
                var result = await SignInManager.PasswordSignInAsync(user.UserName, loginModel.Password, false, false);
                if (result.Succeeded)
                {
                    // merge carts: demo-session -> user cart
                    await CartService.MergeCartAsync("demo-session", user);
                    Navigation.NavigateTo(string.IsNullOrEmpty(returnUrl) ? "/" : returnUrl);
                    return;
                }

                // If sign-in couldn't set cookie because headers already started, fallback to posting a non-Blazor form
                // Always attempt non-Blazor fallback to ensure cookie is set properly when needed
                try
                {
                    // include session id so server-side MergeCart can run
                    var sessionId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "verona_cart_id");
                    await JSRuntime.InvokeVoidAsync("(function(user,password,returnUrl,sessionId){ document.getElementById('fallback-user').value=user; document.getElementById('fallback-password').value=password; document.getElementById('fallback-returnUrl').value=returnUrl; document.getElementById('fallback-sessionId').value=sessionId; document.getElementById('fallbackLoginForm').submit(); })", user.UserName, loginModel.Password, string.IsNullOrEmpty(returnUrl) ? "/" : returnUrl, sessionId);
                    return;
                }
                catch
                {
                    // JS interop may fail in prerendering; continue to other checks
                }

                var pwOk = await UserManager.CheckPasswordAsync(user, loginModel.Password);
                if (pwOk)
                {
                    await SignInManager.SignInAsync(user, isPersistent: false);
                    await CartService.MergeCartAsync("demo-session", user);
                    Navigation.NavigateTo(string.IsNullOrEmpty(returnUrl) ? "/" : returnUrl);
                    return;
                }

                if (result.IsLockedOut)
                {
                    errorMessage = "Account locked out.";
                    return;
                }
                if (result.IsNotAllowed)
                {
                    errorMessage = "Login not allowed. Please check if your account requires confirmation.";
                    return;
                }
                errorMessage = "Invalid username or password.";
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Login error: {ex}");
                errorMessage = "An error occurred during login. Check server logs.";
            }
        }
        else
        {
            errorMessage = "Invalid username or password.";
        }
    }
}