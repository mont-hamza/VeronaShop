@page "/checkout"
@attribute [Authorize]

@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject VeronaShop.Services.CartService CartService
@inject VeronaShop.Services.IEmailSender EmailSender
@inject NavigationManager NavigationManager
@using System.Linq
@using VeronaShop.Data
@rendermode InteractiveServer

<h3>Checkout</h3>

@if (cart == null)
{
    <p>Loading cart...</p>
}
else if (!cart.Items.Any())
{
    <p>Your cart is empty.</p>
}
else
{
    <p>Review your order:</p>
    <EditForm OnValidSubmit="PlaceOrder" FormName="CheckoutForm">
        <ul>
            @foreach (var it in cart.Items)
            {
                <li>@it.Product.Name x @it.Quantity - @it.UnitPrice</li>
            }
        </ul>

        <MudButton Type="Submit" Variant="Variant.Filled" Color="Color.Primary">Place order</MudButton>
    </EditForm>
}

@code {
    VeronaShop.Data.Entites.Cart cart;

    protected override async Task OnInitializedAsync()
    {
        cart = await CartService.GetOrCreateCartAsync("demo-session");
    }

    private async Task PlaceOrder()
    {
        // create order
        var order = new VeronaShop.Data.Entites.Orders
        {
            OrderNumber = $"ORD-{DateTimeOffset.UtcNow:yyyyMMddHHmmss}",
            OrderDate = DateTimeOffset.UtcNow.DateTime,
            CustomerId = cart.CustomerId ?? 0,
            TotalAmount = cart.Items.Sum(i => i.UnitPrice * i.Quantity),
            ShippingCost = 0,
            IsPaid = false,
            CreatedAt = DateTimeOffset.UtcNow
        };

        using (var db = DbFactory.CreateDbContext())
        {
            db.Orders.Add(order);
            await db.SaveChangesAsync();

            foreach (var it in cart.Items)
            {
                var line = new VeronaShop.Data.Entites.OrderProduct
                {
                    OrderId = order.Id,
                    ProductId = it.ProductId,
                    ProductName = it.Product.Name,
                    UnitPrice = it.UnitPrice,
                    Quantity = it.Quantity
                };
                db.OrderProducts.Add(line);
            }

            await db.SaveChangesAsync();

            var invoice = new VeronaShop.Data.Entites.Invoice
            {
                OrderId = order.Id,
                IssuedAt = DateTimeOffset.UtcNow,
                Amount = order.TotalAmount,
                Email = cart.Customer?.Email ?? "customer@local",
                Notes = "Invoice for your order"
            };

            db.Invoices.Add(invoice);
            await db.SaveChangesAsync();

            // remove cart items using same short-lived context
            var cartItems = db.CartItems.Where(ci => ci.CartId == cart.Id).ToList();
            db.CartItems.RemoveRange(cartItems);
            db.Carts.Remove(db.Carts.Find(cart.Id));
            await db.SaveChangesAsync();
        }
        // send email (outside DB context)
        await EmailSender.SendEmailAsync(order.Customer?.Email ?? cart.Customer?.Email ?? "customer@local", "Your invoice", $"Invoice for order {order.OrderNumber}");

        NavigationManager.NavigateTo("/");
    }
}