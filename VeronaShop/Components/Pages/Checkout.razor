@page "/checkout"
@attribute [Authorize]

@inject VeronaShop.Data.Entites.ApplicationDbContext Db
@inject VeronaShop.Services.CartService CartService
@inject VeronaShop.Services.IEmailSender EmailSender
@inject NavigationManager NavigationManager
@using System.Linq
@rendermode InteractiveServer

<h3>Checkout</h3>

@if (cart == null)
{
    <p>Loading cart...</p>
}
else if (!cart.Items.Any())
{
    <p>Your cart is empty.</p>
}
else
{
    <p>Review your order:</p>
    <EditForm OnValidSubmit="PlaceOrder" FormName="CheckoutForm">
        <ul>
            @foreach (var it in cart.Items)
            {
                <li>@it.Product.Name x @it.Quantity - @it.UnitPrice</li>
            }
        </ul>

        <MudButton Type="Submit" Variant="Variant.Filled" Color="Color.Primary">Place order</MudButton>
    </EditForm>
}

@code {
    VeronaShop.Data.Entites.Cart cart;

    protected override async Task OnInitializedAsync()
    {
        cart = await CartService.GetOrCreateCartAsync("demo-session");
    }

    private async Task PlaceOrder()
    {
        // create order
        var order = new VeronaShop.Data.Entites.Orders
        {
            OrderNumber = $"ORD-{DateTimeOffset.UtcNow:yyyyMMddHHmmss}",
            OrderDate = DateTimeOffset.UtcNow.DateTime,
            CustomerId = cart.CustomerId ?? 0,
            TotalAmount = cart.Items.Sum(i => i.UnitPrice * i.Quantity),
            ShippingCost = 0,
            IsPaid = false,
            CreatedAt = DateTimeOffset.UtcNow
        };

        Db.Orders.Add(order);
        await Db.SaveChangesAsync();

        foreach (var it in cart.Items)
        {
            var line = new VeronaShop.Data.Entites.OrderProduct
            {
                OrderId = order.Id,
                ProductId = it.ProductId,
                ProductName = it.Product.Name,
                UnitPrice = it.UnitPrice,
                Quantity = it.Quantity
            };
            Db.OrderProducts.Add(line);
        }

        await Db.SaveChangesAsync();

        var invoice = new VeronaShop.Data.Entites.Invoice
        {
            OrderId = order.Id,
            IssuedAt = DateTimeOffset.UtcNow,
            Amount = order.TotalAmount,
            Email = cart.Customer?.Email ?? "customer@local",
            Notes = "Invoice for your order"
        };

        Db.Invoices.Add(invoice);
        await Db.SaveChangesAsync();

        // send email
        await EmailSender.SendEmailAsync(invoice.Email, "Your invoice", $"Invoice #{invoice.Id} for {invoice.Amount}");

        // clear cart
        foreach (var it in cart.Items.ToList())
        {
            Db.CartItems.Remove(it);
        }
        await Db.SaveChangesAsync();

        NavigationManager.NavigateTo("/");
    }
}