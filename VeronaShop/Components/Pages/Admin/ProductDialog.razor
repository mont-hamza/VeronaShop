@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using VeronaShop.Data
@using VeronaShop.Data.Entites
// ImageSharp types referenced with fully-qualified names to avoid conflicts with MudBlazor types
@using SixLabors.ImageSharp.Processing
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject IWebHostEnvironment Env
@rendermode InteractiveServer

<MudPaper Class="pa-3">
    <EditForm Model="Model" OnValidSubmit="HandleValidSubmit" FormName="ProductForm">
            <DataAnnotationsValidator />
            <MudTextField @bind-Value="Model.Name" Label="Name" Required="true" />
            <MudTextField @bind-Value="Model.SKU" Label="SKU" />
            <MudTextField @bind-Value="Model.Price" Label="Price" InputType="InputType.Number" Required="true" />
            <MudTextField @bind-Value="Model.StockQuantity" Label="Stock Quantity" InputType="InputType.Number" />

            <MudSelect T="int?" Label="Category" @bind-Value="Model.CategoryId">
                <MudSelectItem T="int?" Value="null">(none)</MudSelectItem>
                @foreach (var c in categories)
                {
                    <MudSelectItem T="int?" Value="@c.Id">@c.Name</MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="int?" Label="Supplier" @bind-Value="Model.SupplierId">
                <MudSelectItem T="int?" Value="null">(none)</MudSelectItem>
                @foreach (var s in suppliers)
                {
                    <MudSelectItem T="int?" Value="@s.Id">@s.CompanyName</MudSelectItem>
                }
            </MudSelect>

            <InputFile OnChange="OnInputFileChange" Multiple="true" />
            @if (previewUrls != null && previewUrls.Any())
            {
                <div class="d-flex" style="gap:8px;flex-wrap:wrap;">
                    @for (int idx = 0; idx < previewUrls.Count; idx++)
                    {
                        var u = previewUrls[idx];
                        <div class="d-flex flex-column align-center" style="width:120px;">
                            <img src="@u" style="max-width:120px;max-height:120px;object-fit:contain;border:1px solid #e0e0e0;padding:6px" />
                            <div class="mt-1 d-flex" style="gap:6px;justify-content:center;">
                                <MudIconButton Size="Size.Small" Icon="Icons.Material.Filled.ArrowUpward" OnClick="@(() => MoveImageUp(idx))" />
                                <MudIconButton Size="Size.Small" Icon="Icons.Material.Filled.ArrowDownward" OnClick="@(() => MoveImageDown(idx))" />
                                <MudIconButton Size="Size.Small" Icon="Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemovePreview(idx))" />
                            </div>
                        </div>
                    }
                </div>
            }

            <div class="mt-2">
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="@(MudBlazor.Color.Primary)">Save</MudButton>
                <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
            </div>
        </EditForm>
    </MudPaper>

@code{
    [Parameter] public Product Model { get; set; }
    [Parameter] public EventCallback<bool> OnSaved { get; set; }

    private List<Category> categories = new();
    private List<Supplier> suppliers = new();
    private List<IBrowserFile> files = new();
    private List<string> previewUrls = new();
    // mapping of existing image url -> image id for images already persisted
    private Dictionary<string, int> existingImageIds = new();

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();
        categories = await db.Categories.OrderBy(c => c.Name).ToListAsync();
        suppliers = await db.Suppliers.OrderBy(s => s.CompanyName).ToListAsync();
        // populate preview URLs from model images if present
        if (Model != null)
        {
            if (Model.Images != null && Model.Images.Any())
            {
                var imgs = Model.Images.OrderBy(i => i.SortOrder).ToList();
                previewUrls = imgs.Select(i => i.Url).ToList();
                existingImageIds = imgs.ToDictionary(i => i.Url, i => i.Id);
            }
            else if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                previewUrls = new List<string> { Model.ImageUrl };
            }
        }
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        files = e.GetMultipleFiles().ToList();
        // Save uploaded file to wwwroot/uploads/products and use relative path
        try
        {
            var uploads = Path.Combine(Env.WebRootPath ?? "wwwroot", "uploads", "products");
            Directory.CreateDirectory(uploads);
            previewUrls.Clear();
            var max = 10 * 1024 * 1024;
            foreach (var f in files)
            {
                var ext = Path.GetExtension(f.Name);
                var fileName = Guid.NewGuid().ToString() + ext;
                var fullPath = Path.Combine(uploads, fileName);
                using var stream = f.OpenReadStream(max);
            // validate content type
                if (!f.ContentType.StartsWith("image/"))
            {
                Snackbar.Add("Only image files are allowed", Severity.Error);
                return;
            }
            // resize using ImageSharp
                using var image = SixLabors.ImageSharp.Image.Load<SixLabors.ImageSharp.PixelFormats.Rgba32>(stream);
                image.Mutate(x => x.Resize(new SixLabors.ImageSharp.Processing.ResizeOptions { Mode = SixLabors.ImageSharp.Processing.ResizeMode.Max, Size = new SixLabors.ImageSharp.Size(1200, 1200) }));
                using (var fsOut = File.Create(fullPath))
                {
                    var encoder = new SixLabors.ImageSharp.Formats.Jpeg.JpegEncoder() { Quality = 85 };
                    image.Save(fsOut, encoder);
                }
                var rel = $"/uploads/products/{fileName}";
                previewUrls.Add(rel);
                // append to model images as temp; persistence occurs on save
                Model.ImageUrl = Model.ImageUrl ?? string.Empty; // keep legacy
            }
            // don't overwrite Model.ImageUrl for now
        }
        catch (Exception ex)
        {
            try { Snackbar.Add($"Failed to save image: {ex.Message}", Severity.Error); } catch { }
        }
    }

    private async Task HandleValidSubmit()
    {
        if (Model.Id == 0)
        {
            Model.CreatedAt = DateTimeOffset.UtcNow;
            using var db = DbFactory.CreateDbContext();
            db.Products.Add(Model);
            await db.SaveChangesAsync();
            // persist uploaded images
            if (previewUrls.Any())
            {
                for (int i = 0; i < previewUrls.Count; i++)
                {
                    var url = previewUrls[i];
                    db.ProductImages.Add(new ProductImage { ProductId = Model.Id, Url = url, SortOrder = i, CreatedAt = DateTimeOffset.UtcNow });
                }
                await db.SaveChangesAsync();
            }
            Snackbar.Add("Product created", Severity.Success);
        }
        else
        {
            using var db = DbFactory.CreateDbContext();
            var existing = await db.Products.FindAsync(Model.Id);
            if (existing != null)
            {
                var oldImage = existing.ImageUrl ?? string.Empty;
                existing.Name = Model.Name;
                existing.SKU = Model.SKU;
                existing.Price = Model.Price;
                existing.StockQuantity = Model.StockQuantity;
                existing.CategoryId = Model.CategoryId;
                existing.SupplierId = Model.SupplierId;
                existing.ImageUrl = Model.ImageUrl;
                existing.UpdatedAt = DateTimeOffset.UtcNow;
                await db.SaveChangesAsync();
                // Sync image records: ensure DB has entries matching previewUrls (in order), remove any others
                var dbImages = await db.ProductImages.Where(pi => pi.ProductId == existing.Id).ToListAsync();
                var toDelete = dbImages.Where(d => !previewUrls.Contains(d.Url)).ToList();
                if (toDelete.Any())
                {
                    db.ProductImages.RemoveRange(toDelete);
                    // also delete physical files if under uploads
                    foreach (var d in toDelete)
                    {
                        try
                        {
                            if (!string.IsNullOrEmpty(d.Url) && d.Url.StartsWith("/uploads/products/"))
                            {
                                var physical = Path.Combine(Env.WebRootPath ?? "wwwroot", d.Url.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
                                if (File.Exists(physical)) File.Delete(physical);
                            }
                        }
                        catch { }
                    }
                }
                // upsert remaining and new
                for (int i = 0; i < previewUrls.Count; i++)
                {
                    var url = previewUrls[i];
                    var found = dbImages.FirstOrDefault(d => d.Url == url);
                    if (found != null)
                    {
                        found.SortOrder = i;
                        db.ProductImages.Update(found);
                    }
                    else
                    {
                        db.ProductImages.Add(new ProductImage { ProductId = existing.Id, Url = url, SortOrder = i, CreatedAt = DateTimeOffset.UtcNow });
                    }
                }
                await db.SaveChangesAsync();
                Snackbar.Add("Product updated", Severity.Success);
                // cleanup orphaned old image if replaced
                try
                {
                    if (!string.IsNullOrEmpty(oldImage) && oldImage.StartsWith("/uploads/products/") && oldImage != Model.ImageUrl)
                    {
                        var physical = Path.Combine(Env.WebRootPath ?? "wwwroot", oldImage.TrimStart('/').Replace('/', Path.DirectorySeparatorChar));
                        if (File.Exists(physical)) File.Delete(physical);
                    }
                }
                catch { }
            }
        }

        await OnSaved.InvokeAsync(true);
    }

    private void Cancel()
    {
        OnSaved.InvokeAsync(false);
    }

    private void RemovePreview(int idx)
    {
        if (idx < 0 || idx >= previewUrls.Count) return;
        var url = previewUrls[idx];
        previewUrls.RemoveAt(idx);
        // if it's an existing persisted image, mark for deletion in next save by not including it
    }

    private void MoveImageUp(int idx)
    {
        if (idx <= 0 || idx >= previewUrls.Count) return;
        var v = previewUrls[idx];
        previewUrls.RemoveAt(idx);
        previewUrls.Insert(idx - 1, v);
    }

    private void MoveImageDown(int idx)
    {
        if (idx < 0 || idx >= previewUrls.Count - 1) return;
        var v = previewUrls[idx];
        previewUrls.RemoveAt(idx);
        previewUrls.Insert(idx + 1, v);
    }
}
