@using VeronaShop.Data.Entites
@using VeronaShop.Services
@inject CartService CartService
@inject VeronaShop.Services.CartSessionService CartSession
@inject NavigationManager Navigation
@using MudBlazor

<MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Inherit" OnClick="GoToCart">
    @if (count > 0)
    {
        <MudBadge Dot="false" Content="@count" Color="Color.Error" Class="mud-badge-overlap" />
    }
</MudIconButton>

@code {
    private int count;
    protected override async Task OnInitializedAsync()
    {
        // try to get session id and set initial count
        try
        {
            var sessionId = await CartSession.GetOrCreateSessionIdAsync();
            count = await CartService.GetCartItemCountAsync(sessionId);
        }
        catch { count = 0; }

        CartService.CartCountChanged += OnCartCountChanged;
    }

    private void OnCartCountChanged(int newCount)
    {
        count = newCount;
        InvokeAsync(StateHasChanged);
    }

    private void GoToCart()
    {
        Navigation.NavigateTo("/cart");
    }

    public void Dispose()
    {
        CartService.CartCountChanged -= OnCartCountChanged;
    }
}
